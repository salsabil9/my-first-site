<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>المنزل الآمن: تشافي صدمات الطفولة</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&family=Amiri:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* CSS Variables for colors and fonts - Easy customization */
        :root {
            /* Light Mode Colors */
            --light-bg: #F0F2F5; /* A soft, light blue-grey */
            --light-text-color: #333;
            --light-primary-color: #4CAF50; /* A vibrant green for main elements */
            --light-secondary-color: #2196F3; /* A bright blue for accents and highlights */
            --light-accent-color: #FFC107; /* A warm yellow for interactive elements */
            --light-card-bg: #FFFFFF; /* Pure white for cards */
            --light-border-color: #E0E0E0; /* Light grey for subtle borders */
            --light-shadow: 0 4px 12px rgba(0, 0, 0, 0.08); /* Soft, subtle shadow */

            /* Dark Mode Colors */
            --dark-bg: #1A202C; /* Dark charcoal */
            --dark-text-color: #E2E8F0; /* Off-white for text */
            --dark-primary-color: #689F38; /* A darker, more muted green */
            --dark-secondary-color: #1976D2; /* A darker, richer blue */
            --dark-accent-color: #FFB300; /* A deeper yellow */
            --dark-card-bg: #2D3748; /* Darker grey for cards */
            --dark-border-color: #4A5568; /* Muted grey for borders */
            --dark-shadow: 0 4px 12px rgba(0, 0, 0, 0.2); /* Deeper shadow for contrast */

            /* Current active colors (default to light) */
            --current-bg: var(--light-bg);
            --current-text-color: var(--light-text-color);
            --current-primary-color: var(--light-primary-color);
            --current-secondary-color: var(--light-secondary-color);
            --current-accent-color: var(--light-accent-color);
            --current-card-bg: var(--light-card-bg);
            --current-border-color: var(--light-border-color);
            --current-shadow: var(--light-shadow);

            /* Fonts */
            --heading-font: 'Amiri', serif;
            --body-font: 'Cairo', sans-serif;
        }

        /* Base styles */
        body {
            font-family: var(--body-font);
            margin: 0;
            padding: 0;
            background-color: var(--current-bg);
            color: var(--current-text-color);
            line-height: 1.6;
            direction: rtl; /* Right-to-left for Arabic */
            text-align: right;
            transition: background-color 0.5s ease, color 0.5s ease; /* Smooth mode transition */
            overflow-x: hidden; /* Prevent horizontal scroll */
        }

        /* Initial Assessment Overlay */
        #assessment-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8); /* Dark overlay */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000; /* Above everything else */
            backdrop-filter: blur(5px); /* Blurred background */
            transition: opacity 0.5s ease;
        }

        .assessment-card {
            background-color: var(--light-card-bg); /* Always light for assessment */
            color: var(--light-text-color);
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            max-width: 600px;
            text-align: center;
            animation: fadeInScale 0.6s ease-out; /* Animation on load */
        }

        .assessment-card h2 {
            font-family: var(--heading-font);
            color: var(--light-primary-color);
            margin-bottom: 25px;
            font-size: 2.2em;
            border-bottom: 2px solid var(--light-primary-color);
            padding-bottom: 10px;
        }

        .assessment-card p {
            font-size: 1.1em;
            margin-bottom: 25px;
        }

        .assessment-card .quiz-question {
            background-color: var(--light-border-color);
            border: 1px solid var(--light-border-color);
            box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.05);
        }
        .assessment-card .quiz-question label:hover {
            background-color: var(--light-bg);
        }
        .assessment-card .quiz-question input[type="radio"]:checked + label {
            background-color: var(--light-secondary-color);
            color: white;
            border-color: var(--light-secondary-color);
        }

        .assessment-card .btn {
            background-color: var(--light-accent-color);
            color: var(--light-text-color);
            margin-top: 20px;
        }
        .assessment-card .btn:hover {
            background-color: var(--light-primary-color);
            color: white;
        }


        /* Main container layout using Flexbox */
        .container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 0 20px;
            display: flex;
            gap: 20px; /* Space between sidebar and main content */
            flex-wrap: wrap; /* Allow wrapping on smaller screens */
            justify-content: center; /* Center items when wrapped */
        }

        /* Sidebar Navigation - Canva Style */
        .sidebar {
            width: 250px;
            background-color: var(--current-card-bg);
            padding: 20px;
            border-radius: 12px; /* Rounded corners */
            box-shadow: var(--current-shadow); /* Soft shadow */
            flex-shrink: 0; /* Prevent shrinking */
            position: sticky; /* Sticky sidebar for long content */
            top: 20px; /* Position from top */
            height: fit-content; /* Fit content height */
            z-index: 1000; /* Ensure it's above other content */
        }

        .sidebar h2 {
            font-family: var(--heading-font);
            color: var(--current-primary-color);
            text-align: center;
            margin-bottom: 30px;
            font-size: 1.8em;
            border-bottom: 2px solid var(--current-primary-color);
            padding-bottom: 10px;
        }

        .sidebar ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .sidebar ul li {
            margin-bottom: 10px;
        }

        .sidebar ul li a {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            color: var(--current-text-color);
            text-decoration: none;
            font-weight: bold;
            border-radius: 8px;
            transition: background-color 0.3s ease, color 0.3s ease, box-shadow 0.3s ease;
        }

        .sidebar ul li a i {
            margin-left: 10px; /* Space for icon */
            font-size: 1.2em;
        }

        .sidebar ul li a:hover,
        .sidebar ul li a.active {
            background-color: var(--current-secondary-color);
            color: white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1); /* Subtle lift on hover/active */
        }

        /* Main Content Area */
        .main-content {
            flex-grow: 1; /* Allows it to take remaining space */
            min-width: 700px; /* Minimum width for content to prevent squishing */
        }

        header {
            background-color: var(--current-primary-color);
            color: white;
            padding: 20px 0;
            text-align: center;
            box-shadow: var(--current-shadow);
            border-radius: 12px;
            margin-bottom: 20px;
        }

        header h1 {
            margin: 0;
            font-size: 2.5em;
            font-family: var(--heading-font);
        }

        section {
            background-color: var(--current-card-bg);
            padding: 40px;
            margin-bottom: 20px;
            border-radius: 12px;
            box-shadow: var(--current-shadow);
            display: none; /* Hidden by default, shown by JS */
            opacity: 0; /* For fade-in effect */
            transform: translateY(20px); /* For slight slide-up effect */
            transition: opacity 0.5s ease, transform 0.5s ease;
        }

        section.active {
            display: block; /* Show active section */
            opacity: 1; /* Fade in */
            transform: translateY(0); /* Slide up to position */
        }

        h2 {
            font-family: var(--heading-font);
            color: var(--current-primary-color);
            font-size: 2em;
            border-bottom: 2px solid var(--current-primary-color);
            padding-bottom: 10px;
            margin-bottom: 30px;
            text-align: right;
        }

        h3 {
            font-family: var(--heading-font);
            color: var(--current-secondary-color);
            font-size: 1.5em;
            margin-top: 30px;
            margin-bottom: 15px;
            text-align: right;
        }

        p {
            font-size: 1.1em;
            line-height: 1.8;
            margin-bottom: 15px;
        }

        /* Buttons - Modern & Interactive */
        .btn {
            display: inline-block;
            background-color: var(--current-accent-color);
            color: var(--current-text-color); /* Text color adjusts with mode */
            padding: 12px 25px;
            text-decoration: none;
            border-radius: 8px;
            font-weight: bold;
            transition: background-color 0.3s ease, transform 0.2s ease, color 0.3s ease;
            border: none;
            cursor: pointer;
            font-size: 1em;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1); /* Subtle shadow */
        }

        .btn:hover {
            background-color: var(--current-primary-color);
            color: white; /* Text turns white on hover */
            transform: translateY(-2px); /* Slight lift */
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2); /* More prominent shadow */
        }

        .btn-secondary {
            background-color: var(--current-secondary-color);
            color: white;
        }
        .btn-secondary:hover {
            background-color: var(--current-primary-color);
        }

        /* Quiz Section Styling */
        .quiz-question {
            background-color: var(--current-border-color); /* Uses border color for subtle background */
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: inset 0 0 8px rgba(0, 0, 0, 0.05); /* Inner shadow for depth */
        }
        .quiz-question p {
            font-weight: bold;
            margin-bottom: 10px;
            color: var(--current-primary-color); /* Question text stands out */
        }
        .quiz-question label {
            display: block;
            margin-bottom: 8px;
            cursor: pointer;
            padding: 10px 15px; /* More padding */
            background-color: var(--current-card-bg);
            border-radius: 5px;
            transition: background-color 0.2s ease, box-shadow 0.2s ease;
            border: 1px solid var(--current-border-color); /* Subtle border */
        }
        .quiz-question label:hover {
            background-color: var(--light-bg); /* Use light background for hover to show difference */
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        body.dark-mode .quiz-question label:hover {
            background-color: #3f4a5a; /* Darker background for hover in dark mode */
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }
        .quiz-question input[type="radio"]:checked + label {
            background-color: var(--current-secondary-color);
            color: white;
            border-color: var(--current-secondary-color);
        }


        /* Tasks Section Styling */
        .tasks-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .task-card {
            background-color: var(--current-border-color);
            padding: 25px;
            border-radius: 10px;
            box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.1);
            transition: background-color 0.3s ease, color 0.3s ease, opacity 0.3s ease;
            position: relative; /* For badge positioning */
        }
        .task-card h4 {
            color: var(--current-secondary-color);
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 1.3em;
        }
        .task-card p {
            margin-bottom: 15px;
            font-size: 1em;
        }
        .task-card .task-completion {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 20px;
        }
        .task-card .task-completion input[type="checkbox"] {
            transform: scale(1.5);
            margin-left: 10px; /* Space for checkbox */
            cursor: pointer;
            accent-color: var(--current-primary-color); /* Checkbox color */
        }
        .task-card.completed {
            opacity: 0.8; /* Slightly transparent when completed */
            background-color: var(--current-primary-color);
            color: white;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
        }
        .task-card.completed h4 {
            color: white;
        }
        .task-card.completed p {
            color: rgba(255, 255, 255, 0.9); /* Lighter text for completed tasks */
        }

        /* Completed Task Badge */
        .task-card.completed::after {
            content: "\f00c"; /* Font Awesome check icon */
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: var(--current-accent-color);
            color: white;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1em;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        /* Score & Progress Styling */
        .progress-container {
            background-color: var(--current-border-color);
            padding: 25px;
            border-radius: 10px;
            margin-top: 20px;
            box-shadow: var(--current-shadow);
        }
        .progress-bar-wrapper {
            width: 100%;
            background-color: var(--light-bg); /* Fixed light background for progress bar */
            border-radius: 15px;
            overflow: hidden;
            height: 30px;
            margin-top: 15px;
            border: 1px solid var(--current-border-color);
        }
        body.dark-mode .progress-bar-wrapper {
            background-color: #333; /* Darker background for progress bar in dark mode */
        }
        .progress-bar {
            height: 100%;
            width: 0%;
            background-color: var(--current-primary-color);
            border-radius: 15px;
            text-align: center;
            color: white;
            line-height: 30px;
            transition: width 0.5s ease-in-out;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            white-space: nowrap; /* Prevent text wrap */
        }
        .score-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px;
        }

        /* Journal/Notebook Styling */
        .notebook-container {
            margin-top: 20px;
        }
        #journalEntry {
            width: 100%;
            min-height: 300px;
            padding: 15px;
            border: 1px solid var(--current-border-color);
            border-radius: 8px;
            font-family: var(--body-font);
            font-size: 1.1em;
            background-color: var(--current-card-bg);
            color: var(--current-text-color);
            resize: vertical; /* Allow vertical resizing */
            box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.05);
            outline: none; /* Remove default focus outline */
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }
        #journalEntry:focus {
            border-color: var(--current-secondary-color);
            box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.1), 0 0 0 3px rgba(33, 150, 243, 0.2); /* Blue glow on focus */
        }
        #saveJournalBtn {
            margin-top: 15px;
        }

        /* Nature Connection Section */
        .nature-image-container {
            width: 100%;
            height: 300px; /* Fixed height for consistency */
            background-size: cover;
            background-position: center;
            border-radius: 10px;
            box-shadow: var(--current-shadow);
            margin-bottom: 20px;
            transition: background-image 1s ease-in-out; /* Smooth image transition */
        }
        .nature-image-caption {
            text-align: center;
            font-style: italic;
            color: var(--current-text-color);
            margin-top: 10px;
        }

        /* Day/Night Mode Toggle */
        .mode-toggle {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: 30px;
            background-color: var(--current-border-color);
            padding: 8px;
            border-radius: 50px; /* Pill shape */
            box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.1);
        }
        .mode-toggle button {
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            color: var(--current-text-color);
            padding: 8px 15px;
            border-radius: 50px;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        .mode-toggle button:hover {
            background-color: rgba(0, 0, 0, 0.1);
        }
        .mode-toggle button.active {
            background-color: var(--current-secondary-color);
            color: white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        /* Audio Controls Styling */
        .audio-controls {
            display: flex;
            flex-wrap: wrap; /* Allow wrapping of buttons */
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--current-border-color);
        }
        .audio-controls button {
            background-color: var(--current-secondary-color);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.95em; /* Slightly smaller font for buttons */
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background-color 0.3s ease, box-shadow 0.2s ease;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        .audio-controls button:hover {
            background-color: var(--current-primary-color);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }
        .audio-controls button.active {
            background-color: var(--current-primary-color);
            box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.2); /* Inset shadow for active state */
        }

        /* Hide audio elements visually */
        audio {
            display: none;
        }


        /* Dark Mode Specific Styles - Applies when body has .dark-mode class */
        body.dark-mode {
            --current-bg: var(--dark-bg);
            --current-text-color: var(--dark-text-color);
            --current-primary-color: var(--dark-primary-color);
            --current-secondary-color: var(--dark-secondary-color);
            --current-accent-color: var(--dark-accent-color);
            --current-card-bg: var(--dark-card-bg);
            --current-border-color: var(--dark-border-color);
            --current-shadow: var(--dark-shadow);
        }

        /* Animations */
        @keyframes fadeInScale {
            from {
                opacity: 0;
                transform: scale(0.95);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Responsive Adjustments */
        @media (max-width: 992px) {
            .container {
                flex-direction: column;
                align-items: center;
            }
            .sidebar {
                width: 90%;
                position: static; /* Remove sticky on small screens */
                margin-bottom: 20px;
            }
            .main-content {
                min-width: unset; /* Remove min-width */
                width: 100%;
            }
            section {
                padding: 20px;
            }
            .assessment-card {
                padding: 30px;
            }
        }

        @media (max-width: 768px) {
            header h1 {
                font-size: 1.8em;
            }
            h2 {
                font-size: 1.6em;
            }
            h3 {
                font-size: 1.3em;
            }
            .btn {
                padding: 10px 20px;
                font-size: 0.9em;
            }
            .audio-controls button {
                font-size: 0.9em;
                padding: 8px 12px;
            }
            .assessment-card {
                padding: 20px;
                max-width: 90%;
            }
            .assessment-card h2 {
                font-size: 1.8em;
            }
        }
    </style>
</head>
<body>

    <div id="assessment-overlay">
        <div class="assessment-card">
            <h2><i class="fas fa-brain"></i> تقييمك النفسي الأولي</h2>
            <p>قبل الدخول إلى منزلك الآمن، يرجى الإجابة عن هذه الأسئلة لمساعدتنا في فهم احتياجاتك وتخصيص تجربتك.</p>
            <form id="initialAssessmentForm">
                <div class="quiz-question">
                    <p>1. في الأسبوع الماضي، كم مرة شعرت بالتوتر أو القلق الشديد؟</p>
                    <label><input type="radio" name="initialQ1" value="3"> معظم الوقت</label>
                    <label><input type="radio" name="initialQ1" value="2"> أحيانًا</label>
                    <label><input type="radio" name="initialQ1" value="1"> نادرًا</label>
                    <label><input type="radio" name="initialQ1" value="0"> أبدًا</label>
                </div>
                <div class="quiz-question">
                    <p>2. هل واجهت صعوبة في النوم أو البقاء نائمًا؟</p>
                    <label><input type="radio" name="initialQ2" value="3"> كل ليلة تقريبًا</label>
                    <label><input type="radio" name="initialQ2" value="2"> عدة ليالٍ في الأسبوع</label>
                    <label><input type="radio" name="initialQ2" value="1"> ليلة أو ليلتين في الأسبوع</label>
                    <label><input type="radio" name="initialQ2" value="0"> لا أواجه صعوبة</label>
                </div>
                <div class="quiz-question">
                    <p>3. هل تشعر بالإرهاق أو نقص الطاقة بشكل متكرر؟</p>
                    <label><input type="radio" name="initialQ3" value="3"> نعم، غالبًا</label>
                    <label><input type="radio" name="initialQ3" value="2"> أحيانًا</label>
                    <label><input type="radio" name="initialQ3" value="1"> نادرًا</label>
                    <label><input type="radio" name="initialQ3" value="0"> أبدًا</label>
                </div>
                <div class="quiz-question">
                    <p>4. هل تجد صعوبة في الاستمتاع بالأنشطة التي كنت تستمتع بها سابقًا؟</p>
                    <label><input type="radio" name="initialQ4" value="3"> نعم، بشكل كبير</label>
                    <label><input type="radio" name="initialQ4" value="2"> أحيانًا</label>
                    <label><input type="radio" name="initialQ4" value="1"> نادرًا</label>
                    <label><input type="radio" name="initialQ4" value="0"> لا أواجه صعوبة</label>
                </div>
                <div class="quiz-question">
                    <p>5. هل شعرت بالوحدة أو العزلة الاجتماعية؟</p>
                    <label><input type="radio" name="initialQ5" value="3"> معظم الوقت</label>
                    <label><input type="radio" name="initialQ5" value="2"> أحيانًا</label>
                    <label><input type="radio" name="initialQ5" value="1"> نادرًا</label>
                    <label><input type="radio" name="initialQ5" value="0"> أبدًا</label>
                </div>
                <button type="submit" class="btn">ابدأ رحلتي</button>
            </form>
        </div>
    </div>

    <audio id="windSound" loop></audio>
    <audio id="nightSound" loop></audio>

    <div class="container" style="display: none;"> <aside class="sidebar">
            <h2><i class="fas fa-home"></i> المنزل الآمن</h2>
            <nav>
                <ul>
                    <li><a href="#welcome" class="nav-link active"><i class="fas fa-hand-sparkles"></i> مرحبًا بك</a></li>
                    <li><a href="#daily-task" class="nav-link"><i class="fas fa-calendar-day"></i> مهمة اليوم</a></li>
                    <li><a href="#nature" class="nav-link"><i class="fas fa-leaf"></i> التواصل مع الطبيعة</a></li>
                    <li><a href="#quiz" class="nav-link"><i class="fas fa-question-circle"></i> اختبار التشافي</a></li>
                    <li><a href="#progress" class="nav-link"><i class="fas fa-chart-line"></i> تتبع التقدم</a></li>
                    <li><a href="#journal" class="nav-link"><i class="fas fa-book"></i> مذكرة التدوين</a></li>
                    <li><a href="#resources" class="nav-link"><i class="fas fa-hand-holding-heart"></i> مصادر الدعم</a></li>
                </ul>
            </nav>
            <div class="mode-toggle">
                <button id="dayModeBtn" class="active"><i class="fas fa-sun"></i></button>
                <button id="nightModeBtn"><i class="fas fa-moon"></i></button>
            </div>
            <div class="audio-controls">
                <button id="playWindBtn"><i class="fas fa-wind"></i> تشغيل الريح</button>
                <button id="playNightBtn"><i class="fas fa-moon"></i> تشغيل الليل</button>
                <button id="stopAllAudioBtn"><i class="fas fa-stop"></i> إيقاف الصوت</button>
            </div>
        </aside>

        <main class="main-content">
            <header>
                <h1>المنزل الآمن</h1>
                <p>مساحتك للتشافي والنمو من صدمات الطفولة</p>
            </header>

            <section id="welcome" class="active">
                <h2>أهلاً بك في منزلك الآمن</h2>
                <p>هنا تبدأ رحلة التعافي من صدمات الطفولة. نحن نؤمن بأن كل شخص يستحق الشفاء والعيش بحرية من آثار الماضي. هذا الدليل ليس بديلاً عن الدعم المهني، ولكنه أداة لمساعدتك على فهم نفسك بشكل أفضل، وتحديد مسار للشفاء يناسبك.</p>
                <p>ابدأ بمهمة **"مهمة اليوم"** لتحديد المهام المناسبة لك.</p>
                <button class="btn btn-secondary" onclick="showSection('daily-task')">انتقل إلى مهمة اليوم</button>
            </section>

            <section id="daily-task">
                <h2><i class="fas fa-calendar-day"></i> مهمة اليوم</h2>
                <p>كل يوم يقربك خطوة من التشافي. إليك مهمتك لهذا اليوم:</p>
                <div class="task-card" id="currentDailyTaskCard">
                    <h4 id="dailyTaskTitle">جاري تحميل المهمة...</h4>
                    <p id="dailyTaskDescription">مهمتك اليومية هنا.</p>
                    <div class="task-completion">
                        <span>أنجزت هذه المهمة؟</span>
                        <input type="checkbox" id="dailyTaskCheckbox">
                    </div>
                </div>
                <p style="margin-top: 20px;">**ملاحظة:** تظهر مهمة جديدة كل يوم. عد غداً لمهمة جديدة!</p>
            </section>

            <section id="nature">
                <h2><i class="fas fa-leaf"></i> التواصل مع الطبيعة</h2>
                <p>انغمس في جمال الطبيعة لتهدئة روحك. هذه الصور تذكرك بجمال العالم من حولك.</p>
                <div class="nature-image-container" id="natureImageContainer"></div>
                <p class="nature-image-caption" id="natureImageCaption"></p>
                <button class="btn" id="nextNatureImageBtn">صورة طبيعة أخرى <i class="fas fa-arrow-left"></i></button>
            </section>

            <section id="quiz">
                <h2><i class="fas fa-question-circle"></i> اختبار احتياجات التشافي</h2>
                <p>أجب عن الأسئلة التالية بصدق لمساعدتنا في تخصيص المهام العلاجية لك. لا توجد إجابات صحيحة أو خاطئة، وهذا الاختبار للإرشاد فقط.</p>
                <form id="healingQuiz">
                    <div class="quiz-question">
                        <p>1. هل تجد صعوبة في الثقة بالآخرين، حتى المقربين منهم؟</p>
                        <label><input type="radio" name="q1" value="1"> غالبًا ما أجد صعوبة.</label>
                        <label><input type="radio" name="q1" value="0"> أحيانًا أجد صعوبة.</label>
                        <label><input type="radio" name="q1" value="-1"> نادرًا ما أجد صعوبة.</label>
                    </div>
                    <div class="quiz-question">
                        <p>2. هل تشعر أحيانًا أنك تعيش الماضي، أو أن الذكريات السيئة تسيطر عليك فجأة؟</p>
                        <label><input type="radio" name="q2" value="1"> نعم، يحدث كثيرًا.</label>
                        <label><input type="radio" name="q2" value="0"> أحيانًا.</label>
                        <label><input type="radio" name="q2" value="-1"> نادرًا أو لا يحدث أبدًا.</label>
                    </div>
                    <div class="quiz-question">
                        <p>3. كيف تتعامل مع الغضب أو الحزن الشديد؟</p>
                        <label><input type="radio" name="q3" value="1"> غالبًا ما أكبت مشاعري أو أنفجر.</label>
                        <label><input type="radio" name="q3" value="0"> أحاول السيطرة عليها، لكنها صعبة أحيانًا.</label>
                        <label><input type="radio" name="q3" value="-1"> أستطيع التعبير عنها بطرق صحية.</label>
                    </div>
                    <div class="quiz-question">
                        <p>4. هل تشعر بالذنب أو الخجل بشأن أحداث ماضية، حتى لو لم تكن مسؤولاً عنها؟</p>
                        <label><input type="radio" name="q4" value="1"> نعم، غالبًا ما أشعر بذلك.</label>
                        <label><input type="radio" name="q4" value="0"> أحيانًا، لكن أحاول تجاوزها.</label>
                        <label><input type="radio" name="q4" value="-1"> لا أشعر بذلك غالبًا.</label>
                    </div>
                    <div class="quiz-question">
                        <p>5. هل تواجه صعوبة في وضع حدود صحية في علاقاتك؟</p>
                        <label><input type="radio" name="q5" value="1"> نعم، أجد صعوبة كبيرة.</label>
                        <label><input type="radio" name="q5" value="0"> أحيانًا، لكنني أعمل على ذلك.</label>
                        <label><input type="radio" name="q5" value="-1"> أستطيع وضع حدود واضحة.</label>
                    </div>
                    <div class="quiz-question">
                        <p>6. هل تلاحظ أنك تنجذب لأنماط علاقات غير صحية أو مدمرة؟</p>
                        <label><input type="radio" name="q6" value="1"> نعم، يبدو أنني أكرر نفس الأخطاء.</label>
                        <label><input type="radio" name="q6" value="0"> أحيانًا، لكنني أصبح أكثر وعيًا.</label>
                        <label><input type="radio" name="q6" value="-1"> لا أجد صعوبة في اختيار العلاقات الصحية.</label>
                    </div>
                    <div class="quiz-question">
                        <p>7. هل تعاني من مشاكل في النوم (أرق، كوابيس، استيقاظ متكرر)؟</p>
                        <label><input type="radio" name="q7" value="1"> نعم، غالبًا.</label>
                        <label><input type="radio" name="q7" value="0"> أحيانًا.</label>
                        <label><input type="radio" name="q7" value="-1"> نادرًا أو لا أواجه مشاكل في النوم.</label>
                    </div>
                    <div class="quiz-question">
                        <p>8. هل تلجأ إلى آليات تأقلم غير صحية (مثل الإفراط في الأكل، تعاطي المواد، إدمان العمل) للتعامل مع التوتر؟</p>
                        <label><input type="radio" name="q8" value="1"> نعم، هذه عادتي.</label>
                        <label><input type="radio" name="q8" value="0"> أحيانًا، لكنني أحاول التوقف.</label>
                        <label><input type="radio" name="q8" value="-1"> أتعامل مع التوتر بطرق صحية.</label>
                    </div>
                    <div class="quiz-question">
                        <p>9. هل تشعر بانفصال عن مشاعرك أو عن الواقع أحيانًا؟</p>
                        <label><input type="radio" name="q9" value="1"> نعم، أشعر بالخدر العاطفي.</label>
                        <label><input type="radio" name="q9" value="0"> أحيانًا، في المواقف الصعبة.</label>
                        <label><input type="radio" name="q9" value="-1"> نادرًا ما أشعر بذلك.</label>
                    </div>
                    <div class="quiz-question">
                        <p>10. هل تجد صعوبة في الشعور بالأمان أو الاسترخاء في بيئات معينة؟</p>
                        <label><input type="radio" name="q10" value="1"> نعم، أشعر بالتوتر غالبًا.</label>
                        <label><input type="radio" name="q10" value="0"> أحيانًا، في الأماكن غير المألوفة.</label>
                        <label><input type="radio" name="q10" value="-1"> أشعر بالأمان والاسترخاء بسهولة.</label>
                    </div>
                    <div class="quiz-question">
                        <p>11. هل تعاني من مشاكل صحية جسدية مزمنة (مثل الصداع، مشاكل الجهاز الهضمي) بدون سبب عضوي واضح؟</p>
                        <label><input type="radio" name="q11" value="1"> نعم، أعاني منها غالبًا.</label>
                        <label><input type="radio" name="q11" value="0"> أحيانًا.</label>
                        <label><input type="radio" name="q11" value="-1"> نادرًا أو لا أعاني منها.</label>
                    </div>
                    <div class="quiz-question">
                        <p>12. هل تجد صعوبة في التسامح مع نفسك أو مع الآخرين على أخطاء الماضي؟</p>
                        <label><input type="radio" name="q12" value="1"> نعم، أجد صعوبة كبيرة.</label>
                        <label><input type="radio" name="q12" value="0"> أحيانًا، لكنني أحاول.</label>
                        <label><input type="radio" name="q12" value="-1"> أستطيع التسامح بسهولة.</label>
                    </div>
                    <div class="quiz-question">
                <p>13. هل تشعر أحيانًا أنك تستحق ما حدث لك في الماضي؟</p>
                <label><input type="radio" name="q13" value="1"> نعم، هذا الشعور يراودني.</label>
                <label><input type="radio" name="q13" value="0"> أحيانًا، لكنني أعلم أنه غير صحيح.</label>
                <label><input type="radio" name="q13" value="-1"> لا، أعلم أنني لم أكن أستحق ذلك.</label>
            </div>
            <div class="quiz-question">
                <p>14. هل تجد صعوبة في طلب المساعدة أو الدعم عندما تحتاج إليه؟</p>
                <label><input type="radio" name="q14" value="1"> نعم، أجد الأمر محرجًا أو صعبًا.</label>
                <label><input type="radio" name="q14" value="0"> أحيانًا، حسب الموقف.</label>
                <label><input type="radio" name="q14" value="-1"> لا، أستطيع طلب المساعدة بسهولة.</label>
            </div>
            <div class="quiz-question">
                <p>15. هل تشعر أن صدمات الطفولة لا تزال تؤثر بشكل كبير على حياتك اليومية؟</p>
                <label><input type="radio" name="q15" value="1"> نعم، بشكل كبير جدًا.</label>
                <label><input type="radio" name="q15" value="0"> نعم، بشكل متوسط.</label>
                <label><input type="radio" name="q15" value="-1"> لا، تأثيرها محدود أو تلاشى.</label>
            </div>
            <button type="submit" class="btn">احصل على المهام المخصصة</button>
        </form>
    </section>

    <section id="progress">
        <h2><i class="fas fa-chart-line"></i> تتبع التقدم الأسبوعي</h2>
        <p>تابع تقدمك في مهام التشافي. كل مهمة تنجزها تساهم في نقطة تشافي. تذكر أن التشافي عملية مستمرة.</p>
        <div class="progress-container">
            <h3>نقاط التشافي الكلية: <span id="totalHealingPoints">0</span></h3>
            <h3>نسبة التشافي التقديرية: <span id="healingPercentage">0%</span></h3>
            <div class="progress-bar-wrapper">
                <div class="progress-bar" id="healingProgressBar"></div>
            </div>
            <div class="score-info">
                <span>أنجزت <span id="completedTasksCount">0</span> من <span id="totalTasksCount">0</span> مهام.</span>
                <button class="btn btn-secondary" onclick="resetWeeklyProgress()">إعادة تعيين التقدم الأسبوعي</button>
            </div>
        </div>
    </section>

    <section id="journal">
        <h2><i class="fas fa-book"></i> مذكرة التدوين</h2>
        <p>هنا يمكنك تدوين أفكارك ومشاعرك وتجاربك. الكتابة تساعد على معالجة المشاعر واكتشاف الذات. سيتم حفظ ما تكتبه تلقائيًا في متصفحك.</p>
        <div class="notebook-container">
            <textarea id="journalEntry" placeholder="ابدأ بالكتابة هنا..."></textarea>
            <button id="saveJournalBtn" class="btn">حفظ المذكرة</button>
            <p style="margin-top: 10px; font-size: 0.9em; color: gray;">*ملاحظة: يتم حفظ المذكرة تلقائيًا في متصفحك. لن تكون متاحة على أجهزة أخرى.*</p>
        </div>
    </section>

    <section id="resources">
        <h2><i class="fas fa-hand-holding-heart"></i> مصادر الدعم والتعافي</h2>
        <p>لا تتردد في طلب المساعدة. هناك العديد من الموارد المتاحة لمساعدتك في رحلة التعافي.</p>
        <div class="tasks-grid">
            <div class="task-card">
                <h4>العلاج النفسي</h4>
                <p>العلاج السلوكي المعرفي (CBT)، العلاج الجدلي السلوكي (DBT)، وعلاج إزالة حساسية حركة العين وإعادة المعالجة (EMDR) هي بعض الأساليب الفعالة في معالجة صدمات الطفولة.</p>
                <a href="https://www.google.com/search?q=أطباء+نفسيون+متخصصون+في+صدمات+الطفولة" target="_blank" class="btn btn-secondary">ابحث عن معالج</a>
            </div>
            <div class="task-card">
                <h4>مجموعات الدعم</h4>
                <p>الانضمام إلى مجموعات الدعم مع أشخاص يشاركونك تجارب مماثلة يمكن أن يوفر شعورًا بالانتماء والتفهم والدعم المتبادل.</p>
                <a href="https://www.google.com/search?q=مجموعات+دعم+صدمات+الطفولة" target="_blank" class="btn btn-secondary">تعرف على المجموعات</a>
            </div>
            <div class="task-card">
                <h4>كتب وموارد إلكترونية</h4>
                <p>قراءة الكتب والمقالات المتخصصة حول صدمات الطفولة والتعافي منها يمكن أن تزيد من وعيك وتفهمك للموضوع.</p>
                <a href="https://www.google.com/search?q=كتب+عن+علاج+صدمات+الطفولة" target="_blank" class="btn btn-secondary">استكشف الموارد</a>
            </div>
        </div>
    </section>
</main>
</div>

<script>
// --- Global Variables & Initial Setup ---
const sections = document.querySelectorAll('main section');
const navLinks = document.querySelectorAll('.nav-link');
const healingQuizForm = document.getElementById('healingQuiz');
const assignedTasksDiv = document.getElementById('assignedTasks'); // This element is no longer used for daily tasks, but still for initial quiz tasks.
const totalHealingPointsSpan = document.getElementById('totalHealingPoints');
const healingPercentageSpan = document.getElementById('healingPercentage');
const healingProgressBar = document.getElementById('healingProgressBar');
const completedTasksCountSpan = document.getElementById('completedTasksCount');
const totalTasksCountSpan = document.getElementById('totalTasksCount');
const journalEntry = document.getElementById('journalEntry');
const saveJournalBtn = document.getElementById('saveJournalBtn');
const dayModeBtn = document.getElementById('dayModeBtn');
const nightModeBtn = document.getElementById('nightModeBtn');

// Define audio elements
const windSound = document.getElementById('windSound');
const nightSound = document.getElementById('nightSound');

const playWindBtn = document.getElementById('playWindBtn');
const playNightBtn = document.getElementById('playNightBtn');
const stopAllAudioBtn = document.getElementById('stopAllAudioBtn');

// Nature Section elements
const natureImageContainer = document.getElementById('natureImageContainer');
const natureImageCaption = document.getElementById('natureImageCaption');
const nextNatureImageBtn = document.getElementById('nextNatureImageBtn');

// Initial Assessment elements
const assessmentOverlay = document.getElementById('assessment-overlay');
const initialAssessmentForm = document.getElementById('initialAssessmentForm');
let initialHealingScore = 0; // User's initial healing score from assessment

// Daily Task elements
const currentDailyTaskCard = document.getElementById('currentDailyTaskCard');
const dailyTaskTitle = document.getElementById('dailyTaskTitle');
const dailyTaskDescription = document.getElementById('dailyTaskDescription');
const dailyTaskCheckbox = document.getElementById('dailyTaskCheckbox');

// Task definitions (can be expanded)
const initialQuizTasks = { // These are tasks based on the initial comprehensive quiz
    general: [
        { id: 'task_quiz_1', text: 'مارس التنفس الواعي لمدة 5 دقائق يوميًا.' },
        { id: 'task_quiz_2', text: 'اكتب في المذكرة عن مشاعرك مرة واحدة على الأقل هذا الأسبوع.' },
        { id: 'task_quiz_3', text: 'تواصل مع صديق مقرب أو فرد من العائلة واقضِ وقتًا ممتعًا.' },
        { id: 'task_quiz_4', text: 'خصص 30 دقيقة لنشاط تستمتع به ويجلب لك الهدوء.' },
        { id: 'task_quiz_5', text: 'تعلم معلومة جديدة عن صدمات الطفولة أو آليات التأقلم الصحية.' },
    ],
    females: [
        { id: 'task_quiz_F1', text: 'تدربي على قول "لا" لطلب لا تشعرين بالراحة تجاهه.' },
        { id: 'task_quiz_F2', text: 'مارسي التأمل الموجه لتعزيز تقدير الذات.' },
        { id: 'task_quiz_F3', text: 'شاركي مشاعر الخجل أو الذنب مع شخص تثقين به أو معالج.' },
        { id: 'task_quiz_F4', text: 'دللي نفسك بنشاط بسيط (مثل حمام دافئ، قراءة كتاب، مشاهدة فيلم).' },
        { id: 'task_quiz_F5', text: 'ابحثي عن مجموعة دعم نسائية عبر الإنترنت أو في مجتمعك.' },
    ],
    males: [
        { id: 'task_quiz_M1', text: 'اسمح لنفسك بالشعور بالحزن أو الغضب دون الحكم عليه.' },
        { id: 'task_quiz_M2', text: 'مارس نشاطًا بدنيًا قويًا لتفريغ الطاقة السلبية.' },
        { id: 'task_quiz_M3', text: 'تحدث مع مرشد أو ذكر موثوق به عن تحدياتك.' },
        { id: 'task_quiz_M4', text: 'حدد هدفًا صغيرًا وحققه لتعزيز إحساسك بالإنجاز والقوة.' },
        { id: 'task_quiz_M5', text: 'تحدّى فكرة "الرجل القوي الذي لا يبكي" بداخلك.' },
    ]
};

const dailyTasks = [
    { title: "مهمة اليوم 1", description: "اكتب 3 أشياء أنت ممتن لها اليوم." },
    { title: "مهمة اليوم 2", description: "خصص 10 دقائق للتأمل في مكان هادئ." },
    { title: "مهمة اليوم 3", description: "تواصل مع شخص قريب لم تتحدث إليه منذ فترة." },
    { title: "مهمة اليوم 4", description: "اقرأ فصلاً من كتاب ملهم." },
    { title: "مهمة اليوم 5", description: "مارس تمرينًا خفيفًا مثل المشي لمدة 20 دقيقة." },
    { title: "مهمة اليوم 6", description: "اكتب رسالة اعتذار (لنفسك أو لشخص آخر)." },
    { title: "مهمة اليوم 7", description: "حدد هدفًا صغيرًا قابل للتحقيق لهذا الأسبوع." },
    { title: "مهمة اليوم 8", description: "شاهد فيلمًا أو مسلسلًا كوميديًا يجعلك تضحك." },
    { title: "مهمة اليوم 9", description: "جرب وصفة طعام جديدة ومختلفة." },
    { title: "مهمة اليوم 10", description: "استمع إلى بودكاست عن التنمية الذاتية." },
    { title: "مهمة اليوم 11", description: "ارسم شيئًا بسيطًا أو لون صفحة." },
    { title: "مهمة اليوم 12", description: "رتّب جزءًا صغيرًا من منزلك (درج، خزانة)." },
    { title: "مهمة اليوم 13", description: "اسمح لنفسك بأخذ قسط من الراحة دون الشعور بالذنب." },
    { title: "مهمة اليوم 14", description: "اكتب قائمة بالأشياء التي تود تحقيقها في الشهر القادم." },
    { title: "مهمة اليوم 15", description: "مارس اليوجا أو تمارين الإطالة لمدة 15 دقيقة." },
    { title: "مهمة اليوم 16", description: "اكتشف أغنية جديدة أو نوع موسيقي جديد." },
    { title: "مهمة اليوم 17", description: "تحدث مع شخص غريب بطريقة ودودة (في متجر، مقهى)." },
    { title: "مهمة اليوم 18", description: "اكتب عن أحد أحلامك أو طموحاتك." },
    { title: "مهمة اليوم 19", description: "تذكر 3 إنجازات صغيرة قمت بها في حياتك." },
    { title: "مهمة اليوم 20", description: "تطوع بوقتك أو ساعد شخصًا محتاجًا." },
    { title: "مهمة اليوم 21", description: "شاهد وثائقيًا عن الطبيعة أو الحيوانات." },
    { title: "مهمة اليوم 22", description: "أرسل رسالة شكر لشخص أثر في حياتك." },
    { title: "مهمة اليوم 23", description: "جرب أن تكون حاضرًا بشكل كامل في لحظة واحدة (مثال: أثناء تناول الطعام)." },
    { title: "مهمة اليوم 24", description: "تخلص من شيء قديم لا تحتاجه في منزلك." },
    { title: "مهمة اليوم 25", description: "اذهب في نزهة قصيرة في الهواء الطلق." },
    { title: "مهمة اليوم 26", description: "دون 3 صفات إيجابية تحبها في نفسك." },
    { title: "مهمة اليوم 27", description: "شاهد شروق الشمس أو غروبها." },
    { title: "مهمة اليوم 28", description: "جرب تمرينًا رياضيًا جديدًا أو نشاطًا بدنيًا." },
    { title: "مهمة اليوم 29", description: "أعد تواصلًا مع هواية قديمة كنت تستمتع بها." },
    { title: "مهمة اليوم 30", description: "راجع تقدمك خلال الشهر واحتفل بإنجازاتك." }
];

const natureImagesLightMode = [
    { src: 'https://images.unsplash.com/photo-1500964757637-acf1c26dfcd3?crop=entropy&cs=tinysrgb&fit=max&fm=jpg&ixid=M3w0NTIyOTB8MHwxfHNlYXJjaHwxfHxzdW5zZXQlMjBsYWtlfGVufDB8fHx8MTcwMTU1NDg0MXww&ixlib=rb-4.0.3&q=80&w=1080', caption: 'بحيرة عند غروب الشمس' },
    { src: 'https://images.unsplash.com/photo-1470770903676-69d8529db1c2?crop=entropy&cs=tinysrgb&fit=max&fm=jpg&ixid=M3w0NTIyOTB8MHwxfHNlYXJjaHwzMXx8Zm9yZXN0JTIwZGF5bGlnaHR8ZW58MHx8fHwxNzAxNTU0ODQ0fDA&ixlib=rb-4.0.3&q=80&w=1080', caption: 'غابة خضراء مشمسة' },
    { src: 'https://images.unsplash.com/photo-1470240237020-f5a045995584?crop=entropy&cs=tinysrgb&fit=max&fm=jpg&ixid=M3w0NTIyOTB8MHwxfHNlYXJjaHw0OXx8bW91bnRhaW4lMjBzY2VuZXJ5fGVufDB8fHx8MTcwMTU1NDg0N3ww&ixlib=rb-4.0.3&q=80&w=1080', caption: 'جبال خلابة في وضح النهار' },
    { src: 'https://images.unsplash.com/photo-1502652610530-5ff681a941a5?crop=entropy&cs=tinysrgb&fit=max&fm=jpg&ixid=M3w0NTIyOTB8MHwxfHNlYXJjaHwxMjJ8fGJlYWNoJTIwZGF5bGlnaHR8ZW58MHx8fHwxNzA1NTQzNzQ4fDA&ixlib=rb-4.0.3&q=80&w=1080', caption: 'شاطئ مشمس وهادئ' },
    { src: 'https://images.unsplash.com/photo-1472214343130-9b6348ef11c6?crop=entropy&cs=tinysrgb&fit=max&fm=jpg&ixid=M3w0NTIyOTB8MHwxfHNlYXJjaHwyMDF8fGZpZWxkJTIwb2YlMjBmbG93ZXJzfGVufDB8fHx8MTcwNTU0Mzg2N3ww&ixlib=rb-4.0.3&q=80&w=1080', caption: 'حقل من الزهور' }
];

const natureImagesDarkMode = [
    { src: 'https://images.unsplash.com/photo-1447012985160-c3d317058a5e?crop=entropy&cs=tinysrgb&fit=max&fm=jpg&ixid=M3w0NTIyOTB8MHwxfHNlYXJjaHwyMHx8bmlnaHQlMjBmb3Jlc3R8ZW58MHx8fHwxNzAxNTU0OTE0fDA&ixlib=rb-4.0.3&q=80&w=1080', caption: 'غابة ليلية تحت النجوم' },
    { src: 'https://images.unsplash.com/photo-1464802686167-b933a6ce870b?crop=entropy&cs=tinysrgb&fit=max&fm=jpg&ixid=M3w0NTIyOTB8MHwxfHNlYXJjaHwyOXx8bmlnaHQlMjBsYWtlfGVufDB8fHx8MTcwMTU1NDkxN3ww&ixlib=rb-4.0.3&q=80&w=1080', caption: 'بحيرة هادئة في الليل' },
    { src: 'https://images.unsplash.com/photo-1475274474936-ce476318e807?crop=entropy&cs=tinysrgb&fit=max&fm=jpg&ixid=M3w0NTIyOTB8MHwxfHNlYXJjaHwyN3x8c3RhcnJ5JTIwbmlnaHR8ZW58MHx8fHwxNzA1NTQ0MDEyfDA&ixlib=rb-4.0.3&q=80&w=1080', caption: 'سماء مرصعة بالنجوم' },
    { src: 'https://images.unsplash.com/photo-1465101162482-6a4a6e38b0e7?crop=entropy&cs=tinysrgb&fit=max&fm=jpg&ixid=M3w0NTIyOTB8MHwxfHNlYXJjaHwxMzJ8fGZpcmVmbHklMjBuaWdodHxlbnwwfHx8fDE3MDU1NDQxMTJ8MA&ixlib=rb-4.0.3&q=80&w=1080', caption: 'اليراعات في الليل' },
    { src: 'https://images.unsplash.com/photo-1502652610530-5ff681a941a5?crop=entropy&cs=tinysrgb&fit=max&fm=jpg&ixid=M3w0NTIyOTB8MHwxfHNlYXJjaHwyMDF8fG1vb25saWdodCUyMG9uJTIwb3JjZWFuJTIwYXIlMjBub29ufGVufDB8fHx8MTcwNTU0NDI2MXww&ixlib=rb-4.0.3&q=80&w=1080', caption: 'ضوء القمر على المحيط' }
];


let currentNatureImageIndex = 0;
let currentAssignedQuizTasks = []; // To store tasks assigned from the comprehensive quiz
let completedQuizTasks = {}; // To store completion status for each quiz task { taskId: true/false }
let currentWeeklyScore = 0;
const MAX_WEEKLY_SCORE = 100; // Example max score for calculating percentage

// --- Utility Functions ---

// Function to show/hide sections
function showSection(id) {
    sections.forEach(section => {
        section.classList.remove('active');
    });
    document.getElementById(id).classList.add('active');

    navLinks.forEach(link => {
        link.classList.remove('active');
        if (link.getAttribute('href') === '#' + id) {
            link.classList.add('active');
        }
    });

    if (id === 'nature') {
        renderNatureImage();
    }
}

// --- Initial Assessment Logic ---
initialAssessmentForm.addEventListener('submit', function(e) {
    e.preventDefault();
    let score = 0;
    const formData = new FormData(initialAssessmentForm);
    for (let [name, value] of formData.entries()) {
        score += parseInt(value);
    }
    initialHealingScore = score; // Store initial score
    localStorage.setItem('initialHealingScore', initialHealingScore); // Save to local storage
    localStorage.setItem('assessmentCompleted', 'true'); // Mark assessment as completed

    assessmentOverlay.style.opacity = '0';
    setTimeout(() => {
        assessmentOverlay.style.display = 'none';
        document.querySelector('.container').style.display = 'flex'; // Show main content
        // Optionally, assign initial quiz tasks based on this score here
        // assignHealingTasks(initialHealingScore); // Uncomment if you want to assign tasks based on initial assessment
        showSection('welcome'); // Go to welcome page after assessment
    }, 500);
});

// --- Quiz (Comprehensive) Section Logic ---
healingQuizForm.addEventListener('submit', function(e) {
    e.preventDefault();
    let userHealingScore = 0;
    const formData = new FormData(healingQuizForm);
    const answers = {};
    for (let [name, value] of formData.entries()) {
        answers[name] = parseInt(value);
        userHealingScore += parseInt(value);
    }

    console.log("Quiz Score:", userHealingScore); // Debugging

    assignHealingQuizTasks(userHealingScore); // Assign tasks based on this quiz
    showSection('progress'); // Show progress section after quiz, where these tasks are tracked
});

function assignHealingQuizTasks(score) {
    let tasksToAssign = [...initialQuizTasks.general]; // Start with general tasks

    // Example: Assign gender-specific tasks based on a prompt (or an actual selection in a real app)
    const userGender = prompt("الرجاء إدخال جنسك (ذكر/أنثى) لتخصيص المهام في الاختبار الشامل:", "ذكر").trim();
    if (userGender === "أنثى") {
        tasksToAssign = tasksToAssign.concat(initialQuizTasks.females);
    } else if (userGender === "ذكر") {
        tasksToAssign = tasksToAssign.concat(initialQuizTasks.males);
    }

    currentAssignedQuizTasks = tasksToAssign;
    saveQuizTasksToLocalStorage(); // Save these tasks

    // Render the assigned tasks (for the comprehensive quiz) in the progress section (or a dedicated tasks section if you add one)
    renderQuizTasksForProgress();
    updateProgressDisplay();
}

function renderQuizTasksForProgress() {
    // This function will render tasks from the comprehensive quiz
    // For now, these are not directly displayed in a 'tasks' section but impact progress.
    // If you want a dedicated section for these, you'd create a new section for 'المهام الشاملة'
    // and render them there, similar to how daily tasks are rendered.
    // For simplicity, we are just managing their state for the progress bar.
    console.log("Comprehensive Quiz Tasks assigned:", currentAssignedQuizTasks);
}

function updateQuizTaskCompletion(taskId, isChecked) {
    completedQuizTasks[taskId] = isChecked;
    updateProgressDisplay();
    saveQuizTasksToLocalStorage();
}

function saveQuizTasksToLocalStorage() {
    localStorage.setItem('assignedQuizTasks', JSON.stringify(currentAssignedQuizTasks));
    localStorage.setItem('completedQuizTasks', JSON.stringify(completedQuizTasks));
}

function loadQuizTasksFromLocalStorage() {
    const savedAssignedQuizTasks = localStorage.getItem('assignedQuizTasks');
    const savedCompletedQuizTasks = localStorage.getItem('completedQuizTasks');

    if (savedAssignedQuizTasks) {
        currentAssignedQuizTasks = JSON.parse(savedAssignedQuizTasks);
    } else {
        // Default to general tasks if no quiz tasks were assigned yet
        currentAssignedQuizTasks = [...initialQuizTasks.general];
    }

    if (savedCompletedQuizTasks) {
        completedQuizTasks = JSON.parse(savedCompletedTasks);
    }
}


// --- Daily Task Logic ---
function getDayOfYear() {
    const now = new Date();
    const start = new Date(now.getFullYear(), 0, 0);
    const diff = (now - start) + ((start.getTimezoneOffset() - now.getTimezoneOffset()) * 60 * 1000);
    const oneDay = 1000 * 60 * 60 * 24;
    return Math.floor(diff / oneDay);
}

function getDailyTask() {
    const dayIndex = (getDayOfYear() - 1) % dailyTasks.length; // -1 because array is 0-indexed
    return dailyTasks[dayIndex];
}

function renderDailyTask() {
    const task = getDailyTask();
    dailyTaskTitle.textContent = task.title;
    dailyTaskDescription.textContent = task.description;

    const today = new Date().toDateString();
    const savedDailyTask = JSON.parse(localStorage.getItem('dailyTaskStatus') || '{}');

    if (savedDailyTask.date === today) {
        dailyTaskCheckbox.checked = savedDailyTask.completed;
    } else {
        dailyTaskCheckbox.checked = false; // New day, uncheck
        localStorage.setItem('dailyTaskStatus', JSON.stringify({ date: today, completed: false }));
    }
    updateDailyTaskCardStyle(); // Apply completed style if already checked
}

function updateDailyTaskCardStyle() {
    if (dailyTaskCheckbox.checked) {
        currentDailyTaskCard.classList.add('completed');
    } else {
        currentDailyTaskCard.classList.remove('completed');
    }
}

dailyTaskCheckbox.addEventListener('change', function() {
    const today = new Date().toDateString();
    localStorage.setItem('dailyTaskStatus', JSON.stringify({
        date: today,
        completed: this.checked
    }));
    updateDailyTaskCardStyle();
    updateProgressDisplay(); // Update progress when daily task changes
});


// --- Progress Tracking (Combines all tasks now) ---
function updateProgressDisplay() {
    let totalPossiblePoints = 0;
    let completedPoints = 0;

    // Points from Initial Quiz Tasks (if assigned/tracked here)
    if (currentAssignedQuizTasks && currentAssignedQuizTasks.length > 0) {
        totalPossiblePoints += currentAssignedQuizTasks.length;
        currentAssignedQuizTasks.forEach(task => {
            if (completedQuizTasks[task.id]) {
                completedPoints++;
            }
        });
    }

    // Points from Daily Task
    const savedDailyTask = JSON.parse(localStorage.getItem('dailyTaskStatus') || '{}');
    if (savedDailyTask.completed) {
        completedPoints++;
    }
    totalPossiblePoints++; // Daily task always counts as one possible point

    // You can adjust how each type of task contributes to total score if needed.
    // For simplicity, each task (daily or quiz-based) counts as 1 point.

    currentWeeklyScore = (completedPoints / totalPossiblePoints) * MAX_WEEKLY_SCORE || 0;
    currentWeeklyScore = Math.min(currentWeeklyScore, MAX_WEEKLY_SCORE); // Cap at 100%

    totalHealingPointsSpan.textContent = completedPoints;
    healingPercentageSpan.textContent = `${Math.round(currentWeeklyScore)}%`;
    healingProgressBar.style.width = `${Math.round(currentWeeklyScore)}%`;
    completedTasksCountSpan.textContent = completedPoints;
    totalTasksCountSpan.textContent = totalPossiblePoints; // Show total current possible tasks
}

function resetWeeklyProgress() {
    if (confirm("هل أنت متأكد أنك تريد إعادة تعيين تقدم المهام الأسبوعي؟ سيتم إعادة تعيين جميع المهام.")) {
        completedQuizTasks = {}; // Reset comprehensive quiz tasks
        localStorage.removeItem('completedQuizTasks');

        const today = new Date().toDateString();
        localStorage.setItem('dailyTaskStatus', JSON.stringify({ date: today, completed: false })); // Reset daily task
        
        currentWeeklyScore = 0;
        
        renderQuizTasksForProgress(); // Re-render if necessary (mostly for internal state)
        renderDailyTask(); // Reset daily task display
        updateProgressDisplay();
        alert("تم إعادة تعيين تقدم المهام الأسبوعي بنجاح.");
    }
}


// --- Local Storage Management ---
function saveTasksToLocalStorage() {
    // This function is still generic, might be replaced by specific saves
    // For daily tasks, we use 'dailyTaskStatus'
    // For comprehensive quiz tasks, we use 'assignedQuizTasks' and 'completedQuizTasks'
}

function loadTasksFromLocalStorage() {
    loadQuizTasksFromLocalStorage();
    renderDailyTask(); // Load and display daily task
}

// --- Journal Functionality ---
function loadJournalEntry() {
    const savedEntry = localStorage.getItem('journalEntry');
    if (savedEntry) {
        journalEntry.value = savedEntry;
    }
}

function saveJournalEntry() {
    localStorage.setItem('journalEntry', journalEntry.value);
    alert('تم حفظ المذكرة بنجاح!');
}

journalEntry.addEventListener('input', () => {
         // Optional: Auto-save on input with a debounce
         // This prevents saving too frequently while typing.
         clearTimeout(journalEntry.timeout);
         journalEntry.timeout = setTimeout(() => {
             localStorage.setItem('journalEntry', journalEntry.value);
             console.log("Journal auto-saved!");
         }, 1000); // Save after 1 second of no typing
});
saveJournalBtn.addEventListener('click', saveJournalEntry);

// --- Nature Connection Section Logic ---
function renderNatureImage() {
    const isDarkMode = document.body.classList.contains('dark-mode');
    const imagesArray = isDarkMode ? natureImagesDarkMode : natureImagesLightMode;

    // Ensure index loops around
    currentNatureImageIndex = currentNatureImageIndex % imagesArray.length;
    if (currentNatureImageIndex < 0) { // Handle negative if array length is 0 (shouldn't happen with fixed arrays)
        currentNatureImageIndex = imagesArray.length - 1;
    }

    const image = imagesArray[currentNatureImageIndex];
    natureImageContainer.style.backgroundImage = `url('${image.src}')`;
    natureImageCaption.textContent = image.caption;
}

nextNatureImageBtn.addEventListener('click', () => {
    currentNatureImageIndex++;
    renderNatureImage();
});


// --- Day/Night Mode & Sound ---
function stopAllAudio() {
    windSound.pause();
    windSound.currentTime = 0; // Reset audio to start
    nightSound.pause();
    nightSound.currentTime = 0; // Reset audio to start

    // Remove active class from audio buttons if any
    playWindBtn.classList.remove('active');
    playNightBtn.classList.remove('active');
}

function setLightMode() {
    document.body.classList.remove('dark-mode');
    dayModeBtn.classList.add('active');
    nightModeBtn.classList.remove('active');
    localStorage.setItem('theme', 'light');
    stopAllAudio();
    // Play wind sound automatically when switching to light mode
    if (windSound.readyState >= 2) { // Check if audio is ready to play
        windSound.play();
        playWindBtn.classList.add('active');
    } else {
        windSound.addEventListener('canplaythrough', function handler() {
            windSound.play();
            playWindBtn.classList.add('active');
            windSound.removeEventListener('canplaythrough', handler);
        });
    }
    renderNatureImage(); // Update nature image for light mode
}

function setDarkMode() {
    document.body.classList.add('dark-mode');
    nightModeBtn.classList.add('active');
    dayModeBtn.classList.remove('active');
    localStorage.setItem('theme', 'dark');
    stopAllAudio();
    // Play night sound automatically when switching to dark mode
    if (nightSound.readyState >= 2) { // Check if audio is ready to play
        nightSound.play();
        playNightBtn.classList.add('active');
    } else {
        nightSound.addEventListener('canplaythrough', function handler() {
            nightSound.play();
            playNightBtn.classList.add('active');
            nightSound.removeEventListener('canplaythrough', handler);
        });
    }
    renderNatureImage(); // Update nature image for dark mode
}

dayModeBtn.addEventListener('click', setLightMode);
nightModeBtn.addEventListener('click', setDarkMode);

playWindBtn.addEventListener('click', () => {
    stopAllAudio(); // Stop other sounds first
    if (windSound.readyState >= 2) { // Check if audio is ready to play
        windSound.play();
        playWindBtn.classList.add('active');
    } else {
        alert("صوت الريح غير جاهز للتشغيل بعد. يرجى الانتظار قليلاً أو التأكد من الرابط.");
    }
});

playNightBtn.addEventListener('click', () => {
    stopAllAudio(); // Stop other sounds first
    if (nightSound.readyState >= 2) { // Check if audio is ready to play
        nightSound.play();
        playNightBtn.classList.add('active');
    } else {
        alert("صوت الليل غير جاهز للتشغيل بعد. يرجى الانتظار قليلاً أو التأكد من الرابط.");
    }
});

stopAllAudioBtn.addEventListener('click', stopAllAudio);


// Initialize theme and sound on page load
function initializeThemeAndAudio() {
    const savedTheme = localStorage.getItem('theme');
    if (savedTheme === 'dark') {
        document.body.classList.add('dark-mode');
        nightModeBtn.classList.add('active');
        dayModeBtn.classList.remove('active');
        // If dark mode is active, attempt to play night sound
        if (nightSound.readyState >= 2) {
            nightSound.play();
            playNightBtn.classList.add('active');
        } else {
            nightSound.addEventListener('canplaythrough', function handler() {
                nightSound.play();
                playNightBtn.classList.add('active');
                nightSound.removeEventListener('canplaythrough', handler);
            });
        }
    } else {
        document.body.classList.remove('dark-mode');
        dayModeBtn.classList.add('active');
        nightModeBtn.classList.remove('active');
        // If light mode is active, attempt to play wind sound
        if (windSound.readyState >= 2) {
            windSound.play();
            playWindBtn.classList.add('active');
        } else {
            windSound.addEventListener('canplaythrough', function handler() {
                windSound.play();
                playWindBtn.classList.add('active');
                windSound.removeEventListener('canplaythrough', handler);
            });
        }
    }
}


// --- Initial Load & Event Listeners ---
document.addEventListener('DOMContentLoaded', () => {
    // Set audio sources for your custom files
    // **هام: استبدل هذه الروابط بروابط ملفاتك الصوتية الحقيقية التي رفعتها على الإنترنت.**
    windSound.src = "رابط-صوت-الريح-هنا.mp3"; // مثال: "https://example.com/my-wind-sound.mp3"
    nightSound.src = "رابط-صوت-الليل-هنا.mp3"; // مثال: "https://example.com/my-night-sound.mp3"

    // Check if initial assessment is completed
    const assessmentCompleted = localStorage.getItem('assessmentCompleted');
    if (assessmentCompleted === 'true') {
        assessmentOverlay.style.display = 'none';
        document.querySelector('.container').style.display = 'flex'; // Show main content
        initializeThemeAndAudio(); // Initialize theme and audio after main content is shown
    } else {
        assessmentOverlay.style.display = 'flex'; // Show assessment overlay
        document.querySelector('.container').style.display = 'none'; // Hide main content
    }

    loadTasksFromLocalStorage(); // This will also load daily task status
    loadJournalEntry();

    // Setup navigation links
    navLinks.forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            const targetId = this.getAttribute('href').substring(1);
            showSection(targetId);
        });
    });

    // Initial load for daily task and nature image
    renderDailyTask();
    renderNatureImage(); // Ensure nature image is rendered correctly on initial load
    updateProgressDisplay(); // Update progress bar on initial load
});
</script>

</body>
</html>
