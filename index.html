<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>المنزل الآمن: تشافي صدمات الطفولة</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&family=Amiko:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* --- CSS Variables for Theming --- */
        :root {
            /* Light Mode Defaults */
            --bg-color: #F8FF; /* Very light grey */
            --card-bg: #FFFFFF;
            --text-color: #343A40; /* Dark grey for text */
            --primary-color: #5B8C5A; /* Muted Green */
            --secondary-color: #4A90E2; /* Soft Blue */
            --accent-color: #F5B041; /* Warm Yellow */
            --border-color: #E0E0E0; /* Light border */
            --shadow-light: 0 4px 15px rgba(0, 0, 0, 0.08);

            /* Dark Mode Colors (will be applied via .dark-mode class) */
            --dark-bg-color: #2C3E50; /* Darker blue-grey */
            --dark-card-bg: #34495E; /* Slightly lighter than dark-bg */
            --dark-text-color: #ECF0F1; /* Light grey for dark mode text */
            --dark-primary-color: #7DB97D; /* Softer Green */
            --dark-secondary-color: #6FAEE0; /* Softer Blue */
            --dark-accent-color: #F8CB6F; /* Softer Yellow */
            --dark-border-color: #4A637C; /* Darker border */
            --shadow-dark: 0 4px 15px rgba(0, 0, 0, 0.3);

            /* Fonts */
            --font-heading: 'Amiko', serif;
            --font-body: 'Cairo', sans-serif;

            /* Transitions */
            --transition-speed: 0.4s ease-in-out;
        }

        /* --- Base Styles --- */
        html {
            scroll-behavior: smooth; /* Smooth scrolling for anchor links */
        }
        body {
            min-height: 100vh; /* Ensure body takes full viewport height */
            font-family: var(--font-body);
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            direction: rtl; /* Right-to-left for Arabic */
            text-align: right;
            transition: background-color var(--transition-speed), color var(--transition-speed);
            line-height: 1.7;
        }

        /* Dark Mode Specific Styles */
        body.dark-mode {
            background-color: var(--dark-bg-color);
            color: var(--dark-text-color);
            --bg-color: var(--dark-bg-color);
            --card-bg: var(--dark-card-bg);
            --text-color: var(--dark-text-color);
            --primary-color: var(--dark-primary-color);
            --secondary-color: var(--dark-secondary-color);
            --accent-color: var(--dark-accent-color);
            --border-color: var(--dark-border-color);
            --shadow-light: var(--shadow-dark);
        }

        /* --- General Elements Styling --- */
        h1, h2, h3, h4 {
            font-family: var(--font-heading);
            color: var(--primary-color);
            margin-bottom: 20px;
            text-align: right;
        }

        h1 { font-size: 2.8em; }
        h2 { font-size: 2.2em; border-bottom: 2px solid var(--primary-color); padding-bottom: 10px; }
        h3 { font-size: 1.6em; color: var(--secondary-color); }
        h4 { font-size: 1.3em; color: var(--secondary-color); }

        p {
            font-size: 1.1em;
            margin-bottom: 15px;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background-color: var(--accent-color);
            color: var(--text-color);
            padding: 12px 25px;
            border-radius: 8px;
            font-weight: bold;
            text-decoration: none;
            border: none;
            cursor: pointer;
            font-size: 1em;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease, color 0.3s ease;
        }

        .btn:hover {
            background-color: var(--primary-color);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.15);
        }

        .btn-secondary {
            background-color: var(--secondary-color);
            color: white;
        }
        .btn-secondary:hover {
            background-color: var(--primary-color);
        }

        /* --- Assessment Overlay --- */
        #assessment-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.85); /* Darker overlay */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            backdrop-filter: blur(8px); /* More blur */
            opacity: 1;
            visibility: visible;
            transition: opacity 0.6s ease-out, visibility 0.6s ease-out;
            overflow-y: auto; /* Allow scrolling within the overlay if content is too tall */
            padding: 20px; /* Add padding for small screens */
            box-sizing: border-box; /* Include padding in element's total width and height */
        }

        #assessment-overlay.hidden {
            opacity: 0;
            visibility: hidden;
        }

        .assessment-card {
            background-color: var(--card-bg); /* Use theme card bg */
            color: var(--text-color); /* Use theme text color */
            padding: 50px;
            border-radius: 20px; /* More rounded */
            box-shadow: var(--shadow-light);
            max-width: 700px;
            text-align: center;
            animation: fadeInScale 0.7s ease-out;
            border: 1px solid var(--border-color); /* Subtle border */
            width: 100%; /* Ensure it takes full width on small screens */
            box-sizing: border-box; /* Include padding in element's total width and height */
        }

        .assessment-card h2 {
            font-size: 2.5em;
            color: var(--primary-color);
            margin-bottom: 30px;
            border-bottom: none; /* Remove border from card h2 */
        }

        .assessment-card p {
            font-size: 1.2em;
            margin-bottom: 30px;
        }

        .assessment-card .quiz-question {
            background-color: var(--bg-color); /* Lighter background for questions */
            border: 1px solid var(--border-color);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            text-align: right;
            transition: background-color var(--transition-speed), border-color var(--transition-speed);
        }
        .assessment-card .quiz-question p {
            font-weight: 600;
            margin-bottom: 15px;
            font-size: 1.1em;
            color: var(--secondary-color); /* Question text color */
        }
        .assessment-card .quiz-question label {
            display: block;
            background-color: var(--card-bg);
            padding: 12px 18px;
            margin-bottom: 8px;
            border-radius: 8px;
            cursor: pointer;
            border: 1px solid var(--border-color);
            transition: background-color 0.2s ease, border-color 0.2s ease, box-shadow 0.2s ease;
        }
        .assessment-card .quiz-question label:hover {
            background-color: var(--bg-color);
            border-color: var(--secondary-color);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }
        .assessment-card .quiz-question input[type="radio"] {
            display: none; /* Hide default radio button */
        }
        .assessment-card .quiz-question input[type="radio"]:checked + label {
            background-color: var(--secondary-color);
            color: white;
            border-color: var(--secondary-color);
            box-shadow: 0 3px 10px rgba(74, 144, 226, 0.3); /* Blue shadow for selected */
        }
        .assessment-card .btn {
            background-color: var(--primary-color);
            color: white;
            padding: 15px 40px;
            font-size: 1.2em;
            margin-top: 30px;
        }
        .assessment-card .btn:hover {
            background-color: var(--secondary-color);
        }

        /* --- Main Layout --- */
        .container {
            max-width: 1300px;
            margin: 20px auto;
            padding: 0 20px;
            display: flex;
            gap: 25px;
            flex-wrap: wrap; /* Ensure items wrap to next line on smaller screens */
            justify-content: center;
            opacity: 0; /* Hidden initially */
            transform: translateY(20px);
            transition: opacity 0.6s ease-out, transform 0.6s ease-out;
        }

        .container.visible {
            opacity: 1;
            transform: translateY(0);
        }

        /* Sidebar Navigation */
        .sidebar {
            width: 280px;
            background-color: var(--card-bg);
            padding: 25px;
            border-radius: 15px;
            box-shadow: var(--shadow-light);
            flex-shrink: 0;
            position: sticky;
            top: 20px;
            height: fit-content; /* Allow height to adjust to content */
            transition: background-color var(--transition-speed), box-shadow var(--transition-speed);
        }

        .sidebar h2 {
            text-align: center;
            margin-bottom: 30px;
            font-size: 2em;
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 15px;
            color: var(--primary-color);
        }

        .sidebar ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .sidebar ul li {
            margin-bottom: 8px;
        }

        .sidebar ul li a {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            color: var(--text-color);
            text-decoration: none;
            font-weight: 600;
            border-radius: 10px;
            transition: background-color 0.3s ease, color 0.3s ease, transform 0.2s ease;
        }

        .sidebar ul li a i {
            margin-left: 15px; /* Space for icon */
            font-size: 1.3em;
            color: var(--secondary-color);
            transition: color 0.3s ease;
        }

        .sidebar ul li a:hover {
            background-color: var(--bg-color);
            transform: translateX(-5px);
        }
        body.dark-mode .sidebar ul li a:hover {
            background-color: rgba(255, 255, 255, 0.05); /* Lighter hover in dark mode */
        }


        .sidebar ul li a.active {
            background-color: var(--secondary-color);
            color: white;
            box-shadow: 0 4px 12px rgba(74, 144, 226, 0.3);
            transform: translateX(-5px);
        }
        .sidebar ul li a.active i {
            color: white;
        }


        /* Mode Toggle */
        .mode-toggle {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-top: 30px;
            background-color: var(--bg-color);
            padding: 8px;
            border-radius: 50px;
            box-shadow: inset 0 0 8px rgba(0, 0, 0, 0.08);
            transition: background-color var(--transition-speed);
        }
        .mode-toggle button {
            background: none;
            border: none;
            font-size: 1.6em;
            cursor: pointer;
            color: var(--text-color);
            padding: 10px 18px;
            border-radius: 40px;
            transition: background-color 0.3s ease, color 0.3s ease, box-shadow 0.3s ease;
        }
        .mode-toggle button:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }
        body.dark-mode .mode-toggle button:hover {
            background-color: rgba(255, 255, 255, 0.08);
        }
        .mode-toggle button.active {
            background-color: var(--secondary-color);
            color: white;
            box-shadow: 0 2px 10px rgba(74, 144, 226, 0.4);
        }

        /* Audio Controls */
        .audio-controls {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 12px;
            margin-top: 25px;
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
        }
        .audio-controls button {
            background-color: var(--secondary-color);
            color: white;
            border: none;
            padding: 10px 18px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.95em;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background-color 0.3s ease, box-shadow 0.2s ease;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        .audio-controls button:hover {
            background-color: var(--primary-color);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }
        .audio-controls button.active {
            background-color: var(--primary-color);
            box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.3);
        }
        audio { display: none; }

        /* --- Main Content Area --- */
        .main-content {
            flex-grow: 1;
            min-width: 600px;
            max-width: 900px; /* Constrain max width for readability */
        }

        header {
            background-color: var(--primary-color);
            color: white;
            padding: 30px 0;
            text-align: center;
            border-radius: 15px;
            box-shadow: var(--shadow-light);
            margin-bottom: 25px;
            transition: background-color var(--transition-speed), box-shadow var(--transition-speed);
        }

        header h1 {
            margin: 0;
            font-size: 3em;
            color: white;
            border-bottom: none;
        }
        header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        section {
            background-color: var(--card-bg);
            padding: 40px;
            margin-bottom: 25px;
            border-radius: 15px;
            box-shadow: var(--shadow-light);
            display: none;
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.5s ease, transform 0.5s ease, background-color var(--transition-speed), box-shadow var(--transition-speed);
            border: 1px solid var(--border-color);
        }

        section.active {
            display: block;
            opacity: 1;
            transform: translateY(0);
        }

        /* --- Specific Section Styles --- */
        /* Task Cards */
        .task-card {
            background-color: var(--bg-color);
            padding: 25px;
            border-radius: 12px;
            box-shadow: inset 0 0 8px rgba(0, 0, 0, 0.05);
            transition: background-color 0.3s ease, color 0.3s ease, opacity 0.3s ease, box-shadow 0.3s ease;
            position: relative;
            border: 1px solid var(--border-color);
        }
        .task-card h4 {
            margin-top: 0;
            margin-bottom: 15px;
        }
        .task-card p {
            margin-bottom: 15px;
            font-size: 1em;
        }
        .task-card .task-completion {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 20px;
        }
        .task-card input[type="checkbox"] {
            transform: scale(1.6); /* Larger checkbox */
            margin-left: 15px;
            cursor: pointer;
            accent-color: var(--primary-color);
        }
        .task-card.completed {
            background-color: var(--primary-color);
            color: white;
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.2);
            border-color: var(--primary-color);
        }
        .task-card.completed h4, .task-card.completed p {
            color: white;
        }
        .task-card.completed::after {
            content: "\f00c"; /* Font Awesome check icon */
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            position: absolute;
            top: 15px;
            right: 15px;
            background-color: var(--accent-color);
            color: white;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2em;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }
        .tasks-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        /* Progress Bar */
        .progress-container {
            background-color: var(--bg-color);
            padding: 30px;
            border-radius: 12px;
            margin-top: 20px;
            box-shadow: var(--shadow-light);
            border: 1px solid var(--border-color);
            transition: background-color var(--transition-speed), box-shadow var(--transition-speed);
        }
        .progress-container h3 {
            margin-top: 0;
            margin-bottom: 20px;
            color: var(--text-color);
        }
        .progress-bar-wrapper {
            width: 100%;
            background-color: var(--border-color);
            border-radius: 15px;
            overflow: hidden;
            height: 35px;
            margin-top: 15px;
            transition: background-color var(--transition-speed);
        }
        .progress-bar {
            height: 100%;
            width: 0%;
            background-color: var(--primary-color);
            border-radius: 15px;
            text-align: center;
            color: white;
            line-height: 35px;
            transition: width 0.6s ease-in-out;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            white-space: nowrap;
        }
        .score-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 15px;
            font-size: 1.1em;
            color: var(--text-color);
        }

        /* Journal */
        #journalEntry {
            width: 100%;
            min-height: 350px;
            padding: 20px;
            border: 1px solid var(--border-color);
            border-radius: 12px;
            font-family: var(--font-body);
            font-size: 1.1em;
            background-color: var(--bg-color);
            color: var(--text-color);
            resize: vertical;
            box-shadow: inset 0 0 8px rgba(0, 0, 0, 0.05);
            outline: none;
            transition: border-color 0.3s ease, box-shadow 0.3s ease, background-color var(--transition-speed), color var(--transition-speed);
        }
        #journalEntry:focus {
            border-color: var(--secondary-color);
            box-shadow: inset 0 0 8px rgba(0, 0, 0, 0.1), 0 0 0 4px rgba(74, 144, 226, 0.2);
        }
        #saveJournalBtn {
            margin-top: 20px;
        }

        /* Nature Section */
        .nature-image-container {
            width: 100%;
            height: 380px;
            background-size: cover;
            background-position: center;
            border-radius: 15px;
            box-shadow: var(--shadow-light);
            margin-bottom: 25px;
            transition: background-image 1.2s ease-in-out, box-shadow var(--transition-speed);
        }
        .nature-image-caption {
            text-align: center;
            font-style: italic;
            color: var(--text-color);
            margin-top: 15px;
            font-size: 1.1em;
        }
        #nextNatureImageBtn {
            margin-top: 20px;
        }

        /* --- Animations --- */
        @keyframes fadeInScale {
            from { opacity: 0; transform: scale(0.98); }
            to { opacity: 1; transform: scale(1); }
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* --- Responsive Design --- */
        @media (max-width: 1024px) {
            .container {
                flex-direction: column;
                align-items: center;
                padding: 0 15px;
            }
            .sidebar {
                width: 95%;
                position: static;
                margin-bottom: 25px;
                max-width: 400px; /* Limit sidebar width on smaller screens */
            }
            .main-content {
                min-width: unset;
                width: 95%;
            }
            section {
                padding: 30px;
            }
            header h1 {
                font-size: 2.2em;
            }
            h2 {
                font-size: 1.8em;
            }
        }

        @media (max-width: 768px) {
            .assessment-card {
                padding: 30px;
                max-width: 95%;
            }
            .assessment-card h2 {
                font-size: 2em;
            }
            .assessment-card p {
                font-size: 1em;
            }
            .assessment-card .btn {
                padding: 12px 30px;
                font-size: 1.1em;
            }
            .sidebar h2 {
                font-size: 1.6em;
            }
            .sidebar ul li a {
                padding: 12px 15px;
                font-size: 0.95em;
            }
            .sidebar ul li a i {
                font-size: 1.1em;
            }
            .audio-controls button {
                padding: 8px 12px;
                font-size: 0.85em;
            }
            .task-card, .progress-container, #journalEntry, .nature-image-container {
                padding: 20px;
            }
            .nature-image-container {
                height: 280px;
            }
        }

        @media (max-width: 480px) {
            .assessment-card {
                padding: 20px;
            }
            header h1 {
                font-size: 1.8em;
            }
            h2 {
                font-size: 1.5em;
            }
            .btn {
                padding: 10px 20px;
                font-size: 0.9em;
            }
        }
    </style>
</head>
<body>

    <div id="assessment-overlay">
        <div class="assessment-card">
            <h2><i class="fas fa-brain"></i> تقييمك النفسي الأولي</h2>
            <p>قبل الدخول إلى منزلك الآمن، يرجى الإجابة عن هذه الأسئلة لمساعدتنا في فهم احتياجاتك وتخصيص تجربتك.</p>
            <form id="initialAssessmentForm">
                <div class="quiz-question">
                    <p>1. في الأسبوع الماضي، كم مرة شعرت بالتوتر أو القلق الشديد؟</p>
                    <label><input type="radio" name="initialQ1" value="3" required> معظم الوقت</label>
                    <label><input type="radio" name="initialQ1" value="2"> أحيانًا</label>
                    <label><input type="radio" name="initialQ1" value="1"> نادرًا</label>
                    <label><input type="radio" name="initialQ1" value="0"> أبدًا</label>
                </div>
                <div class="quiz-question">
                    <p>2. هل واجهت صعوبة في النوم أو البقاء نائمًا؟</p>
                    <label><input type="radio" name="initialQ2" value="3" required> كل ليلة تقريبًا</label>
                    <label><input type="radio" name="initialQ2" value="2"> عدة ليالٍ في الأسبوع</label>
                    <label><input type="radio" name="initialQ2" value="1"> ليلة أو ليلتين في الأسبوع</label>
                    <label><input type="radio" name="initialQ2" value="0"> لا أواجه صعوبة</label>
                </div>
                <div class="quiz-question">
                    <p>3. هل تشعر بالإرهاق أو نقص الطاقة بشكل متكرر؟</p>
                    <label><input type="radio" name="initialQ3" value="3" required> نعم، غالبًا</label>
                    <label><input type="radio" name="initialQ3" value="2"> أحيانًا</label>
                    <label><input type="radio" name="initialQ3" value="1"> نادرًا</label>
                    <label><input type="radio" name="initialQ3" value="0"> أبدًا</label>
                </div>
                <button type="submit" class="btn">ابدأ رحلتي</button>
            </form>
        </div>
    </div>

    <audio id="windSound" loop></audio>
    <audio id="nightSound" loop></audio>

    <div class="container">
        <aside class="sidebar">
            <h2><i class="fas fa-home"></i> المنزل الآمن</h2>
            <nav>
                <ul>
                    <li><a href="#welcome" class="nav-link active"><i class="fas fa-hand-sparkles"></i> مرحبًا بك</a></li>
                    <li><a href="#daily-task" class="nav-link"><i class="fas fa-calendar-day"></i> مهمة اليوم</a></li>
                    <li><a href="#nature" class="nav-link"><i class="fas fa-leaf"></i> التواصل مع الطبيعة</a></li>
                    <li><a href="#quiz" class="nav-link"><i class="fas fa-question-circle"></i> اختبار التشافي</a></li>
                    <li><a href="#progress" class="nav-link"><i class="fas fa-chart-line"></i> تتبع التقدم</a></li>
                    <li><a href="#journal" class="nav-link"><i class="fas fa-book"></i> مذكرة التدوين</a></li>
                    <li><a href="#resources" class="nav-link"><i class="fas fa-hand-holding-heart"></i> مصادر الدعم</a></li>
                </ul>
            </nav>
            <div class="mode-toggle">
                <button id="dayModeBtn" class="active"><i class="fas fa-sun"></i></button>
                <button id="nightModeBtn"><i class="fas fa-moon"></i></button>
            </div>
            <div class="audio-controls">
                <button id="playWindBtn"><i class="fas fa-wind"></i> تشغيل الريح</button>
                <button id="playNightBtn"><i class="fas fa-moon"></i> تشغيل الليل</button>
                <button id="stopAllAudioBtn"><i class="fas fa-stop"></i> إيقاف الصوت</button>
            </div>
        </aside>

        <main class="main-content">
            <header>
                <h1>المنزل الآمن</h1>
                <p>مساحتك للتشافي والنمو من صدمات الطفولة</p>
            </header>

            <section id="welcome" class="active">
                <h2>أهلاً بك في منزلك الآمن</h2>
                <p>هنا تبدأ رحلة التعافي من صدمات الطفولة. نحن نؤمن بأن كل شخص يستحق الشفاء والعيش بحرية من آثار الماضي. هذا الدليل ليس بديلاً عن الدعم المهني، ولكنه أداة لمساعدتك على فهم نفسك بشكل أفضل، وتحديد مسار للشفاء يناسبك.</p>
                <p>ابدأ بـ **"مهمة اليوم"** لتحديد المهام المناسبة لك والمتابعة اليومية.</p>
                <button class="btn btn-secondary" onclick="showSection('daily-task')"><i class="fas fa-arrow-left"></i> انتقل إلى مهمة اليوم</button>
            </section>

            <section id="daily-task">
                <h2><i class="fas fa-calendar-day"></i> مهمة اليوم</h2>
                <p>كل يوم يقربك خطوة من التشافي. إليك مهمتك لهذا اليوم:</p>
                <div class="task-card" id="currentDailyTaskCard">
                    <h4 id="dailyTaskTitle">جاري تحميل المهمة...</h4>
                    <p id="dailyTaskDescription">مهمتك اليومية هنا.</p>
                    <div class="task-completion">
                        <span>أنجزت هذه المهمة؟</span>
                        <input type="checkbox" id="dailyTaskCheckbox">
                    </div>
                </div>
                <p style="margin-top: 20px; font-size: 0.95em; opacity: 0.8;">**ملاحظة:** تظهر مهمة جديدة كل يوم. عد غداً لمهمة جديدة!</p>
            </section>

            <section id="nature">
                <h2><i class="fas fa-leaf"></i> التواصل مع الطبيعة</h2>
                <p>انغمس في جمال الطبيعة لتهدئة روحك. هذه الصور تذكرك بجمال العالم من حولك.</p>
                <div class="nature-image-container" id="natureImageContainer"></div>
                <p class="nature-image-caption" id="natureImageCaption"></p>
                <button class="btn" id="nextNatureImageBtn">صورة طبيعة أخرى <i class="fas fa-arrow-left"></i></button>
            </section>

            <section id="quiz">
                <h2><i class="fas fa-question-circle"></i> اختبار احتياجات التشافي</h2>
                <p>أجب عن الأسئلة التالية بصدق لمساعدتنا في تخصيص المهام العلاجية لك. لا توجد إجابات صحيحة أو خاطئة، وهذا الاختبار للإرشاد فقط.</p>
                <form id="healingQuiz">
                    <div class="quiz-question">
                        <p>1. هل تجد صعوبة في الثقة بالآخرين، حتى المقربين منهم؟</p>
                        <label><input type="radio" name="q1" value="1" required> غالبًا ما أجد صعوبة.</label>
                        <label><input type="radio" name="q1" value="0"> أحيانًا أجد صعوبة.</label>
                        <label><input type="radio" name="q1" value="-1"> نادرًا ما أجد صعوبة.</label>
                    </div>
                    <div class="quiz-question">
                        <p>2. هل تشعر أحيانًا أنك تعيش الماضي، أو أن الذكريات السيئة تسيطر عليك فجأة؟</p>
                        <label><input type="radio" name="q2" value="1" required> نعم، يحدث كثيرًا.</label>
                        <label><input type="radio" name="q2" value="0"> أحيانًا.</label>
                        <label><input type="radio" name="q2" value="-1"> نادرًا أو لا يحدث أبدًا.</label>
                    </div>
                    <div class="quiz-question">
                        <p>3. كيف تتعامل مع الغضب أو الحزن الشديد؟</p>
                        <label><input type="radio" name="q3" value="1" required> غالبًا ما أكبت مشاعري أو أنفجر.</label>
                        <label><input type="radio" name="q3" value="0"> أحاول السيطرة عليها، لكنها صعبة أحيانًا.</label>
                        <label><input type="radio" name="q3" value="-1"> أستطيع التعبير عنها بطرق صحية.</label>
                    </div>
                    <div class="quiz-question">
                        <p>4. هل تشعر بالذنب أو الخجل بشأن أحداث ماضية، حتى لو لم تكن مسؤولاً عنها؟</p>
                        <label><input type="radio" name="q4" value="1" required> نعم، غالبًا ما أشعر بذلك.</label>
                        <label><input type="radio" name="q4" value="0"> أحيانًا، لكن أحاول تجاوزها.</label>
                        <label><input type="radio" name="q4" value="-1"> لا أشعر بذلك غالبًا.</label>
                    </div>
                    <div class="quiz-question">
                        <p>5. هل تواجه صعوبة في وضع حدود صحية في علاقاتك؟</p>
                        <label><input type="radio" name="q5" value="1" required> نعم، أجد صعوبة كبيرة.</label>
                        <label><input type="radio" name="q5" value="0"> أحيانًا، لكنني أعمل على ذلك.</label>
                        <label><input type="radio" name="q5" value="-1"> أستطيع وضع حدود واضحة.</label>
                    </div>
                    <button type="submit" class="btn">احصل على المهام المخصصة</button>
                </form>
            </section>

            <section id="progress">
                <h2><i class="fas fa-chart-line"></i> تتبع التقدم</h2>
                <div class="progress-container">
                    <h3>نتيجة تقييمك الأولي: <span id="initialAssessmentScoreDisplay">لم يتم التقييم</span></h3>
                    <h3>نقاط التشافي الكلية: <span id="totalHealingPoints">0</span></h3>
                    <h3>نسبة التشافي التقديرية: <span id="healingPercentage">0%</span></h3>
                    <div class="progress-bar-wrapper">
                        <div class="progress-bar" id="healingProgressBar"></div>
                    </div>
                    <div class="score-info">
                        <span>أنجزت <span id="completedTasksCount">0</span> من <span id="totalTasksCount">0</span> مهام.</span>
                        <button class="btn btn-secondary" onclick="resetAllProgress()"><i class="fas fa-redo"></i> إعادة تعيين كل التقدم</button>
                    </div>
                </div>
            </section>

            <section id="journal">
                <h2><i class="fas fa-book"></i> مذكرة التدوين</h2>
                <p>هنا يمكنك تدوين أفكارك ومشاعرك وتجاربك. الكتابة تساعد على معالجة المشاعر واكتشاف الذات. سيتم حفظ ما تكتبه تلقائيًا في متصفحك.</p>
                <div class="notebook-container">
                    <textarea id="journalEntry" placeholder="ابدأ بالكتابة هنا..."></textarea>
                    <button id="saveJournalBtn" class="btn"><i class="fas fa-save"></i> حفظ المذكرة</button>
                    <p style="margin-top: 10px; font-size: 0.9em; opacity: 0.7;">*ملاحظة: يتم حفظ المذكرة تلقائيًا في متصفحك. لن تكون متاحة على أجهزة أخرى.*</p>
                </div>
            </section>

            <section id="resources">
                <h2><i class="fas fa-hand-holding-heart"></i> مصادر الدعم والتعافي</h2>
                <p>لا تتردد في طلب المساعدة. هناك العديد من الموارد المتاحة لمساعدتك في رحلة التعافي.</p>
                <div class="tasks-grid">
                    <div class="task-card">
                        <h4>العلاج النفسي</h4>
                        <p>العلاج السلوكي المعرفي (CBT)، العلاج الجدلي السلوكي (DBT)، وعلاج إزالة حساسية حركة العين وإعادة المعالجة (EMDR) هي بعض الأساليب الفعالة في معالجة صدمات الطفولة.</p>
                        <a href="https://www.google.com/search?q=%D8%A3%D8%B7%D8%A8%D8%A7%D8%A1+%D9%86%D9%81%D8%B3%D9%8A%D9%88%D9%86+%D9%85%D8%AA%D8%AE%D8%B5%D8%B5%D9%88%D9%86+%D9%81%D9%8A+%D8%B5%D8%AF%D9%85%D8%A7%D8%AA+%D8%A7%D9%84%D8%B7%D9%81%D9%88%D9%84%D8%A9" target="_blank" class="btn btn-secondary"><i class="fas fa-search"></i> ابحث عن معالج</a>
                    </div>
                    <div class="task-card">
                        <h4>مجموعات الدعم</h4>
                        <p>الانضمام إلى مجموعات الدعم مع أشخاص يشاركونك تجارب مماثلة يمكن أن يوفر شعورًا بالانتماء والتفهم والدعم المتبادل.</p>
                        <a href="https://www.google.com/search?q=%D9%85%D8%AC%D9%85%D9%88%D8%B9%D8%A7%D8%AA+%D8%AF%D8%B9%D9%85+%D8%B5%D8%AF%D9%85%D8%A7%D8%AA+%D8%A7%D9%84%D8%B7%D9%81%D9%88%D9%84%D8%A9" target="_blank" class="btn btn-secondary"><i class="fas fa-users"></i> تعرف على المجموعات</a>
                    </div>
                    <div class="task-card">
                        <h4>كتب وموارد إلكترونية</h4>
                        <p>قراءة الكتب والمقالات المتخصصة حول صدمات الطفولة والتعافي منها يمكن أن تزيد من وعيك وتفهمك للموضوع.</p>
                        <a href="https://www.google.com/search?q=%D9%83%D8%AA%D8%A8+%D8%B9%D9%86+%D8%B9%D9%84%D8%A7%D8%AC+%D8%B5%D8%AF%D9%85%D8%A7%D8%AA+%D8%A7%D9%84%D8%B7%D9%81%D9%88%D9%84%D8%A9" target="_blank" class="btn btn-secondary"><i class="fas fa-book-open"></i> استكشف الموارد</a>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <script>
        // --- Global Variables & Initial Setup ---
        const sections = document.querySelectorAll('main section');
        const navLinks = document.querySelectorAll('.nav-link');
        const healingQuizForm = document.getElementById('healingQuiz');
        const totalHealingPointsSpan = document.getElementById('totalHealingPoints');
        const healingPercentageSpan = document.getElementById('healingPercentage');
        const healingProgressBar = document.getElementById('healingProgressBar');
        const completedTasksCountSpan = document.getElementById('completedTasksCount');
        const totalTasksCountSpan = document.getElementById('totalTasksCount');
        const initialAssessmentScoreDisplay = document.getElementById('initialAssessmentScoreDisplay'); // New element
        const journalEntry = document.getElementById('journalEntry');
        const saveJournalBtn = document.getElementById('saveJournalBtn');
        const dayModeBtn = document.getElementById('dayModeBtn');
        const nightModeBtn = document.getElementById('nightModeBtn');

        const windSound = document.getElementById('windSound');
        const nightSound = document.getElementById('nightSound');
        const playWindBtn = document.getElementById('playWindBtn');
        const playNightBtn = document.getElementById('playNightBtn');
        const stopAllAudioBtn = document.getElementById('stopAllAudioBtn');

        const natureImageContainer = document.getElementById('natureImageContainer');
        const natureImageCaption = document.getElementById('natureImageCaption');
        const nextNatureImageBtn = document.getElementById('nextNatureImageBtn');

        const assessmentOverlay = document.getElementById('assessment-overlay');
        const initialAssessmentForm = document.getElementById('initialAssessmentForm');

        const currentDailyTaskCard = document.getElementById('currentDailyTaskCard');
        const dailyTaskTitle = document.getElementById('dailyTaskTitle');
        const dailyTaskDescription = document.getElementById('dailyTaskDescription');
        const dailyTaskCheckbox = document.getElementById('dailyTaskCheckbox');

        let initialHealingScore = 0;
        let currentNatureImageIndex = 0;
        let currentQuizScore = 0; // Score from the main healing quiz

        // --- CONFIGURE YOUR MEDIA FILES HERE (Real, working links) ---
        // These are direct links to nature sounds from Google Developers
        windSound.src = "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3"; // Placeholder for Wind
        nightSound.src = "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-2.mp3"; // Placeholder for Night
        // To find *actual* nature sounds, I recommend searching on "Freesound.org" or "Pixabay Audio" for direct MP3 links.
        // Example for a real sound:
        // windSound.src = "https://www.dl.freesound.org/download/454845__eardeer__gentle-wind-2.mp3"; // This might require attribution and a direct download link.
        // For testing purposes, SoundHelix is generally reliable for playback.


        // Array of nature images for light mode (Daytime scenes)
        // Ensure these links are direct links to images. Unsplash provides good ones.
        const natureImagesLightMode = [
            { src: 'https://images.unsplash.com/photo-1500964757637-acf1c26dfcd3?crop=entropy&cs=tinysrgb&fit=max&fm=jpg&ixid=M3w0NTIyOTB8MHwxfHxzdW5zZXQlMjBsYWtlfGVufDB8fHx8MTcwMTU1NDg0MXww&ixlib=rb-4.0.3&q=80&w=1080', caption: 'بحيرة عند غروب الشمس' },
            { src: 'https://images.unsplash.com/photo-1470770903676-69d8529db1c2?crop=entropy&cs=tinysrgb&fit=max&fm=jpg&ixid=M3w0NTIyOTB8MHwxfHxmb3Jlc3QlMjBkYXlsaWdobyB8ZW58MHx8fHwxNzAxNTU0ODQ0fDA&ixlib=rb-4.0.3&q=80&w=1080', caption: 'غابة خضراء مشمسة' },
            { src: 'https://images.unsplash.com/photo-1470240237020-f5a045995584?crop=entropy&cs=tinysrgb&fit=max&fm=jpg&ixid=M3w0NTIyOTB8MHwxfHxobW91bnRhaW4lMjBzY2VuZXJ5fGVufDB8fHx8MTcwMTU1NDg0N3ww&ixlib=rb-4.0.3&q=80&w=1080', caption: 'جبال خلابة في وضح النهار' },
            { src: 'https://images.unsplash.com/photo-1502652610530-5ff681a941a5?crop=entropy&cs=tinysrgb&fit=max&fm=jpg&ixid=M3w0NTIyOTB8MHwxfHxiZWFjaCUyMGRheWxpZ2h0fGVufDB8fHx8MTcwNTU0MzczNnw1MjVlZGJjYzgzMzUxMjN8MA&ixlib=rb-4.0.3&q=80&w=1080', caption: 'شاطئ مشمس وهادئ' },
            { src: 'https://images.unsplash.com/photo-1472214343130-9b6348ef11c6?crop=entropy&cs=tinysrgb&fit=max&fm=jpg&ixid=M3w0NTIyOTB8MHwxfHxmaWVsZCUyMG9mJTIwZmxvd2Vyc3xlbnwwfHx8fDE3MDU1NDM4Njd8MA&ixlib=rb-4.0.3&q=80&w=1080', caption: 'حقل من الزهور' }
        ];

        // Array of nature images for dark mode (Nighttime or calming scenes)
        const natureImagesDarkMode = [
            { src: 'https://images.unsplash.com/photo-1447012985160-c3d317058a5e?crop=entropy&cs=tinysrgb&fit=max&fm=jpg&ixid=M3w0NTIyOTB8MHwxfHxuaWdodCUyMGZvcmVzdHxlbnwwfHx8fDE3MDM5MTQ1MDd8MA&ixlib=rb-4.0.3&q=80&w=1080', caption: 'غابة ليلية تحت النجوم' },
            { src: 'https://images.unsplash.com/photo-1464802686167-b933a6ce870b?crop=entropy&cs=tinysrgb&fit=max&fm=jpg&ixid=M3w0NTIyOTB8MHwxfHxuaWdodCUyMGxha2V8ZW58MHx8fHwxNzAzOTE0NTA4fDA&ixlib=rb-4.0.3&q=80&w=1080', caption: 'بحيرة هادئة في الليل' },
            { src: 'https://images.unsplash.com/photo-1475274474936-ce476318e807?crop=entropy&cs=tinysrgb&fit=max&fm=jpg&ixid=M3w0NTIyOTB8MHwxfHxzdGFycnkl205naWdodHxlbnwwfHx8fDE3MDM5MTQ1MTJ8MA&ixlib=rb-4.0.3&q=80&w=1080', caption: 'سماء مرصعة بالنجوم' },
            { src: 'https://images.unsplash.com/photo-1465101162482-6a4a6e38b0e7?crop=entropy&cs=tinysrgb&fit=max&fm=jpg&ixid=M3w0NTIyOTB8MHwxfHxmaXJlZmx5JTIwbmlnaHR8ZW58MHx8fHwxNzAzOTE0NTE2fDA&ixlib=rb-4.0.3&q=80&w=1080', caption: 'اليراعات في الليل' },
            { src: 'https://images.unsplash.com/photo-1502652610530-5ff681a941a5?crop=entropy&cs=tinysrgb&fit=max&fm=jpg&ixid=M3w0NTIyOTB8MHwxfHxtb29ubGlnaHQlMjBvY2VhbnxlbnwwfHx8fDE3MDM5MTQ1MTl8MA&ixlib=rb-4.0.3&q=80&w=1080', caption: 'ضوء القمر على المحيط' }
        ];

        // Daily Task definitions (30 unique tasks for a month cycle)
        const dailyTasks = [
            { id: 'dt1', title: "تأمل التنفس الواعي", description: "اغمض عينيك وركز على أنفاسك لمدة 5 دقائق. لاحظ كيف يدخل ويخرج الهواء من جسدك دون الحكم." },
            { id: 'dt2', title: "تمرين الامتنان", description: "اكتب 3 أشياء تشعر بالامتنان لوجودها في حياتك اليوم، مهما كانت صغيرة." },
            { id: 'dt3', title: "التواصل البناء", description: "تحدث مع شخص تثق به (صديق، فرد عائلة) عن شيء إيجابي حدث لك اليوم." },
            { id: 'dt4', title: "استكشاف جديد", description: "استمع إلى أغنية أو قطعة موسيقية جديدة تثير فيك مشاعر إيجابية." },
            { id: 'dt5', title: "نشاط بدني خفيف", description: "اذهب في نزهة قصيرة لمدة 15-20 دقيقة في الهواء الطلق، ولاحظ التفاصيل من حولك." },
            { id: 'dt6', title: "لحظة استرخاء", description: "خصص 10 دقائق لتناول مشروبك المفضل ببطء وانتباه كامل، واستمتع بكل رشفة." },
            { id: 'dt7', title: "التعبير الفني", description: "ارسم شيئًا بسيطًا، أو قم بتلوين رسمة، أو حتى اكتب جملة إبداعية. لا يهم مدى جودتها." },
            { id: 'dt8', title: "تنظيف مساحة صغيرة", description: "نظم درجًا واحدًا أو جزءًا صغيرًا من غرفتك. الترتيب الخارجي يساعد على الترتيب الداخلي." },
            { id: 'dt9', title: "التواصل مع الطبيعة (نشاط)", description: "اجلس في مكان طبيعي (حديقة، شرفة) ولاحظ 5 أشياء يمكنك رؤيتها، 4 أشياء يمكنك سماعها، 3 أشياء يمكنك شمها، 2 يمكنك لمسها، 1 يمكنك تذوقها (إن أمكن)." },
            { id: 'dt10', title: "تحديد هدف صغير", description: "حدد هدفًا صغيرًا جدًا يمكنك تحقيقه اليوم وشجّع نفسك على إنجازه." },
            { id: 'dt11', title: "تأكيد ذاتي إيجابي", description: "انظر في المرآة وقل لنفسك 3 تأكيدات إيجابية (مثال: 'أنا قوي'، 'أنا أستحق الحب')." },
            { id: 'dt12', title: "مشاهدة ملهمة", description: "شاهد فيديو قصيرًا ملهمًا أو وثائقيًا عن موضوع يثير اهتمامك (بعيدًا عن الأخبار السلبية)." },
            { id: 'dt13', title: "التعلم المستمر", description: "اقرأ مقالًا أو فصلاً قصيرًا من كتاب عن موضوع ينمي وعيك الذاتي أو مهارة جديدة." },
            { id: 'dt14', title: "اللطف العشوائي", description: "قم بعمل لطيف بسيط لشخص آخر، حتى لو كان غريبًا (مثال: ابتسامة، كلمة شكر، فتح باب)." },
            { id: 'dt15', title: "تمرين الاسترخاء العضلي التدريجي", description: "قم بشد ثم إرخاء مجموعة عضلية واحدة تلو الأخرى في جسدك، من أصابع القدم وحتى الرأس." },
            { id: 'dt16', title: "إدارة الوقت الرقمي", description: "حدد ساعة واحدة اليوم تكون فيها بعيدًا عن الشاشات (الهاتف، التلفاز، الكمبيوتر)." },
            { id: 'dt17', title: "التدوين الحر", description: "اكتب بحرية في مذكرتك لمدة 10 دقائق عن أي شيء يخطر ببالك دون قيود أو أحكام." },
            { id: 'dt18', title: "تحضير وجبة صحية", description: "قم بإعداد وجبة واحدة صحية ومغذية لنفسك، واستمتع بعملية الطهي." },
            { id: 'dt19', title: "الاستماع النشط", description: "عند التحدث مع شخص ما، ركز بالكامل على ما يقوله دون مقاطعة أو التفكير في ردك." },
            { id: 'dt20', title: "تخيل مكان آمن", description: "اغمض عينيك وتخيل مكانًا تشعر فيه بالأمان التام والراحة المطلقة. اجعل التفاصيل حية قدر الإمكان." },
            { id: 'dt21', title: "مراجعة اليوم", description: "قبل النوم، فكر في 3 أشياء سارت على ما يرام اليوم، مهما كانت صغيرة." },
            { id: 'dt22', title: "إعطاء الأولوية للنوم", description: "حاول النوم والاستيقاظ في نفس الوقت اليوم للحفاظ على جدول نوم منتظم." },
            { id: 'dt23', title: "تمرين الحدود", description: "مارس قول 'لا' بلطف وحزم لطلب لا ترغب في القيام به، حتى لو كان طلبًا وهميًا." },
            { id: 'dt24', title: "العلاج بالموسيقى", description: "قم بتشغيل قائمة تشغيل من الموسيقى الهادئة والمريحة التي تساعدك على الاسترخاء." },
            { id: 'dt25', title: "التعاطف مع الذات", description: "اكتب رسالة صغيرة لنفسك وكأنك تكتب لصديق يمر بوقت عصيب، وقدم لنفسك الدعم والتعاطف." },
            { id: 'dt26', title: "التخلص من الإلهاء", description: "أغلق جميع الإشعارات على هاتفك لمدة ساعة واحدة على الأقل." },
            { id: 'dt27', title: "التواصل غير اللفظي", description: "تبادل ابتسامة أو إيماءة ودودة مع شخص ما دون الحاجة إلى الكلام." },
            { id: 'dt28', title: "تقييم العواطف", description: "عندما تشعر بمشاعر قوية، حاول تسميتها (غضب، حزن، فرح) وتحديد سببها دون حكم." },
            { id: 'dt29', title: "فحص الجسد", description: "اجلس أو استلقِ وركز على أجزاء مختلفة من جسدك. لاحظ أي توتر أو راحة في كل منطقة." },
            { id: 'dt30', title: "الاحتفال بالتقدم", description: "راجع المهام التي أنجزتها خلال الشهر واحتفل بتقدمك، مهما كان بسيطًا. أنت تستحق ذلك!" }
        ];

        // --- Utility Functions ---

        // Function to get the day number within the year (1 to 365/366)
        function getDayOfYear() {
            const now = new Date();
            const start = new Date(now.getFullYear(), 0, 0); // January 1st of current year
            const diff = (now - start) + ((start.getTimezoneOffset() - now.getTimezoneOffset()) * 60 * 1000);
            const oneDay = 1000 * 60 * 60 * 24;
            return Math.floor(diff / oneDay);
        }

        // Function to show/hide main sections and scroll to top
        function showSection(id) {
            sections.forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(id).classList.add('active');

            navLinks.forEach(link => {
                link.classList.remove('active');
                if (link.getAttribute('href') === '#' + id) {
                    link.classList.add('active');
                }
            });

            if (id === 'nature') {
                renderNatureImage();
            }

            // Scroll to the top of the main content area
            document.querySelector('.main-content').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        // --- Initial Assessment Logic ---
        initialAssessmentForm.addEventListener('submit', function(e) {
            e.preventDefault();
            let score = 0;
            const formData = new FormData(initialAssessmentForm);
            let allQuestionsAnswered = true;

            // Check if all radio buttons are selected
            for (let i = 1; i <= 3; i++) {
                const radios = document.querySelectorAll(`input[name="initialQ${i}"]`);
                const isChecked = Array.from(radios).some(radio => radio.checked);
                if (!isChecked) {
                    allQuestionsAnswered = false;
                    break;
                }
            }

            if (!allQuestionsAnswered) {
                alert("الرجاء الإجابة على جميع الأسئلة قبل المتابعة.");
                return; // Stop the function if not all questions are answered
            }

            for (let [name, value] of formData.entries()) {
                score += parseInt(value);
            }
            initialHealingScore = score; // Store initial score
            localStorage.setItem('initialHealingScore', initialHealingScore);
            localStorage.setItem('assessmentCompleted', 'true');

            // Hide overlay with transition
            assessmentOverlay.classList.add('hidden');
            setTimeout(() => {
                assessmentOverlay.style.display = 'none';
                document.querySelector('.container').classList.add('visible'); // Show main content with transition
                initializeThemeAndAudio(); // Initialize theme and audio after main content is shown
                updateInitialAssessmentScoreDisplay(); // Update display with score
                showSection('welcome'); // Go to welcome page after assessment
            }, 600); // Match CSS transition duration
        });

        function updateInitialAssessmentScoreDisplay() {
            const savedScore = localStorage.getItem('initialHealingScore');
            if (savedScore !== null) {
                initialAssessmentScoreDisplay.textContent = `${savedScore} / 9`; // Max 9 points
                initialAssessmentScoreDisplay.style.color = 'var(--secondary-color)';
                initialAssessmentScoreDisplay.style.fontWeight = 'bold';
            } else {
                initialAssessmentScoreDisplay.textContent = 'لم يتم التقييم';
            }
        }

        // --- Daily Task Logic ---
        function getDailyTask() {
            const dayIndex = (getDayOfYear() - 1) % dailyTasks.length; // Ensure it loops every 30 days
            return dailyTasks[dayIndex];
        }

        function renderDailyTask() {
            const task = getDailyTask();
            dailyTaskTitle.textContent = task.title;
            dailyTaskDescription.textContent = task.description;

            const today = new Date().toDateString();
            const savedDailyTask = JSON.parse(localStorage.getItem('dailyTaskStatus') || '{}');

            // If it's a new day or the task ID has changed, reset the checkbox
            if (savedDailyTask.date !== today || savedDailyTask.taskId !== task.id) {
                dailyTaskCheckbox.checked = false;
                localStorage.setItem('dailyTaskStatus', JSON.stringify({ date: today, completed: false, taskId: task.id }));
            } else {
                dailyTaskCheckbox.checked = savedDailyTask.completed;
            }
            updateDailyTaskCardStyle();
        }

        function updateDailyTaskCardStyle() {
            if (dailyTaskCheckbox.checked) {
                currentDailyTaskCard.classList.add('completed');
            } else {
                currentDailyTaskCard.classList.remove('completed');
            }
        }

        dailyTaskCheckbox.addEventListener('change', function() {
            const today = new Date().toDateString();
            const currentTask = getDailyTask(); // Get the current task to save its ID
            localStorage.setItem('dailyTaskStatus', JSON.stringify({
                date: today,
                completed: this.checked,
                taskId: currentTask.id
            }));
            updateProgressDisplay();
        });


        // --- Comprehensive Quiz Logic (healingQuizForm) ---
        healingQuizForm.addEventListener('submit', function(e) {
            e.preventDefault();
            let quizScore = 0;
            const formData = new FormData(healingQuizForm);
            let allQuestionsAnswered = true;

            // Check if all radio buttons are selected for this form
            for (let i = 1; i <= 5; i++) { // Assuming 5 questions in healingQuizForm
                const radios = document.querySelectorAll(`input[name="q${i}"]`);
                const isChecked = Array.from(radios).some(radio => radio.checked);
                if (!isChecked) {
                    allQuestionsAnswered = false;
                    break;
                }
            }

            if (!allQuestionsAnswered) {
                alert("الرجاء الإجابة على جميع الأسئلة قبل المتابعة.");
                return; // Stop the function if not all questions are answered
            }

            for (let [name, value] of formData.entries()) {
                quizScore += parseInt(value);
            }
            currentQuizScore = quizScore;
            localStorage.setItem('currentQuizScore', currentQuizScore); // Save quiz score

            updateProgressDisplay();
            alert(`تم تسجيل نقاط اختبار التشافي الخاص بك: ${currentQuizScore}. راجع قسم تتبع التقدم!`);
            showSection('progress'); // Go to progress section after quiz
        });


        // --- Progress Tracking ---
        function updateProgressDisplay() {
            let totalPossiblePoints = 0;
            let completedPoints = 0;

            // 1. Initial Assessment Score (max 9 points for 3 questions * 3 max value)
            const initialScore = parseInt(localStorage.getItem('initialHealingScore') || '0');
            const maxInitialScore = 9; // (3 questions * max value 3)
            completedPoints += initialScore;
            totalPossiblePoints += maxInitialScore;


            // 2. Daily Task Contribution (1 point if completed for the day)
            const savedDailyTask = JSON.parse(localStorage.getItem('dailyTaskStatus') || '{}');
            if (savedDailyTask.completed && savedDailyTask.date === new Date().toDateString()) {
                completedPoints += 1;
            }
            totalPossiblePoints += 1; // Daily task always contributes 1 potential point

            // 3. Comprehensive Quiz Score (max 5 points for 5 questions * 1 max value)
            const quizScore = parseInt(localStorage.getItem('currentQuizScore') || '0');
            const maxQuizScore = 5; // (5 questions * max value 1) - max positive score from -1 to 1 per question
            
            // Adjust how quizScore contributes to completedPoints:
            // Max for quiz is 5 (if all answers are 1). Min is -5 (if all answers are -1).
            // To make it contribute positively to 'completedPoints', we can map it.
            // Example: Map -5 to 0, 0 to 2.5, 5 to 5.
            const scaledQuizScore = (quizScore + 5) / 2; // Scales score from 0-5
            completedPoints += scaledQuizScore; // Add scaled score
            totalPossiblePoints += maxQuizScore; // Max possible points from quiz is still 5.

            // Calculate percentage
            const percentage = totalPossiblePoints > 0 ? (completedPoints / totalPossiblePoints) * 100 : 0;
            
            totalHealingPointsSpan.textContent = Math.round(completedPoints); // Round for display
            healingPercentageSpan.textContent = `${Math.round(percentage)}%`;
            healingProgressBar.style.width = `${Math.round(percentage)}%`;
            completedTasksCountSpan.textContent = Math.round(completedPoints);
            totalTasksCountSpan.textContent = totalPossiblePoints;

            updateInitialAssessmentScoreDisplay(); // Ensure initial score is also updated here
        }

        function resetAllProgress() {
            if (confirm("هل أنت متأكد أنك تريد إعادة تعيين كل التقدم؟ سيتم إعادة تعيين التقييمات والمهام المكتملة.")) {
                localStorage.removeItem('initialHealingScore');
                localStorage.removeItem('assessmentCompleted');
                localStorage.removeItem('dailyTaskStatus');
                localStorage.removeItem('currentQuizScore');
                localStorage.removeItem('journalEntry'); // Reset journal too if desired

                // Reset internal state variables
                initialHealingScore = 0;
                currentQuizScore = 0;

                // Reload the page to show assessment overlay again
                location.reload();
            }
        }

        // --- Journal Functionality ---
        function loadJournalEntry() {
            const savedEntry = localStorage.getItem('journalEntry');
            if (savedEntry) {
                journalEntry.value = savedEntry;
            }
        }

        function saveJournalEntry() {
            localStorage.setItem('journalEntry', journalEntry.value);
            alert('تم حفظ المذكرة بنجاح!');
        }

        journalEntry.addEventListener('input', () => {
            clearTimeout(journalEntry.timeout);
            journalEntry.timeout = setTimeout(() => {
                localStorage.setItem('journalEntry', journalEntry.value);
                console.log("Journal auto-saved!");
            }, 1000);
        });
        saveJournalBtn.addEventListener('click', saveJournalEntry);

        // --- Nature Connection Section Logic ---
        function renderNatureImage() {
            const isDarkMode = document.body.classList.contains('dark-mode');
            const imagesArray = isDarkMode ? natureImagesDarkMode : natureImagesLightMode;

            currentNatureImageIndex = currentNatureImageIndex % imagesArray.length;
            if (currentNatureImageIndex < 0) { // Wrap around if using previous button
                currentNatureImageIndex = imagesArray.length - 1;
            }

            const image = imagesArray[currentNatureImageIndex];
            natureImageContainer.style.backgroundImage = `url('${image.src}')`;
            natureImageCaption.textContent = image.caption;
        }

        nextNatureImageBtn.addEventListener('click', () => {
            currentNatureImageIndex++;
            renderNatureImage();
        });


        // --- Day/Night Mode & Sound ---
        function stopAllAudio() {
            windSound.pause();
            windSound.currentTime = 0;
            nightSound.pause();
            nightSound.currentTime = 0;

            playWindBtn.classList.remove('active');
            playNightBtn.classList.remove('active');
        }

        function setLightMode() {
            document.body.classList.remove('dark-mode');
            dayModeBtn.classList.add('active');
            nightModeBtn.classList.remove('active');
            localStorage.setItem('theme', 'light');
            stopAllAudio();
            // Play wind sound automatically when switching to light mode
            if (windSound.readyState >= 2) {
                windSound.play().catch(e => console.error("Error playing wind sound:", e));
                playWindBtn.classList.add('active');
            } else {
                // If audio isn't ready, listen for 'canplaythrough' event
                const handler = () => {
                    windSound.play().catch(e => console.error("Error playing wind sound:", e));
                    playWindBtn.classList.add('active');
                    windSound.removeEventListener('canplaythrough', handler);
                };
                windSound.addEventListener('canplaythrough', handler, { once: true });
                // Attempt to load if not already loaded (e.g., first time)
                if (windSound.networkState === HTMLMediaElement.NETWORK_EMPTY) {
                    windSound.load();
                }
            }
            renderNatureImage();
        }

        function setDarkMode() {
            document.body.classList.add('dark-mode');
            nightModeBtn.classList.add('active');
            dayModeBtn.classList.remove('active');
            localStorage.setItem('theme', 'dark');
            stopAllAudio();
            // Play night sound automatically when switching to dark mode
            if (nightSound.readyState >= 2) {
                nightSound.play().catch(e => console.error("Error playing night sound:", e));
                playNightBtn.classList.add('active');
            } else {
                // If audio isn't ready, listen for 'canplaythrough' event
                const handler = () => {
                    nightSound.play().catch(e => console.error("Error playing night sound:", e));
                    playNightBtn.classList.add('active');
                    nightSound.removeEventListener('canplaythrough', handler);
                };
                nightSound.addEventListener('canplaythrough', handler, { once: true });
                // Attempt to load if not already loaded (e.g., first time)
                if (nightSound.networkState === HTMLMediaElement.NETWORK_EMPTY) {
                    nightSound.load();
                }
            }
            renderNatureImage();
        }

        dayModeBtn.addEventListener('click', setLightMode);
        nightModeBtn.addEventListener('click', setDarkMode);

        playWindBtn.addEventListener('click', () => {
            stopAllAudio();
            if (windSound.readyState >= 2) {
                windSound.play().catch(e => console.error("Error playing wind sound:", e));
                playWindBtn.classList.add('active');
            } else {
                alert("صوت الريح غير جاهز للتشغيل بعد. يرجى الانتظار قليلاً أو التأكد من الرابط.");
                windSound.load(); // Try to load it if not ready
            }
        });

        playNightBtn.addEventListener('click', () => {
            stopAllAudio();
            if (nightSound.readyState >= 2) {
                nightSound.play().catch(e => console.error("Error playing night sound:", e));
                playNightBtn.classList.add('active');
            } else {
                alert("صوت الليل غير جاهز للتشغيل بعد. يرجى الانتظار قليلاً أو التأكد من الرابط.");
                nightSound.load(); // Try to load it if not ready
            }
        });

        stopAllAudioBtn.addEventListener('click', stopAllAudio);

        // Initialize theme and sound on page load
        function initializeThemeAndAudio() {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                setDarkMode();
            } else {
                setLightMode();
            }
        }

        // --- Initial Load & Event Listeners ---
        document.addEventListener('DOMContentLoaded', () => {
            // Check if initial assessment is completed
            const assessmentCompleted = localStorage.getItem('assessmentCompleted');
            if (assessmentCompleted === 'true') {
                assessmentOverlay.style.display = 'none';
                document.querySelector('.container').classList.add('visible'); // Show main content
                initializeThemeAndAudio(); // Initialize theme and audio
            } else {
                assessmentOverlay.style.display = 'flex'; // Show assessment overlay
                document.querySelector('.container').classList.remove('visible'); // Ensure main content is hidden
                // Pre-load audio to be ready when theme is set after assessment
                windSound.load();
                nightSound.load();
            }

            // Load saved data
            initialHealingScore = parseInt(localStorage.getItem('initialHealingScore') || '0');
            currentQuizScore = parseInt(localStorage.getItem('currentQuizScore') || '0');
            loadJournalEntry();
            renderDailyTask(); // Render today's task
            updateProgressDisplay(); // Update progress based on loaded data

            // Setup navigation links
            navLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const targetId = this.getAttribute('href').substring(1);
                    showSection(targetId);
                });
            });
        });
    </script>

</body>
</html>
